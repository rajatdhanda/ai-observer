#!/usr/bin/env node

const path = require('path');
const { spawn } = require('child_process');

// Parse arguments
const args = process.argv.slice(2);
const command = args[0];
const watchMode = args.includes('--watch') || args.includes('-w');
const projectPath = args.find(arg => !arg.startsWith('-') && arg !== 'dashboard') || process.cwd();

if (command === 'dashboard') {
  // Start dashboard server
  console.log('🔍 Starting dashboard server from your local machine...');
  const { spawn } = require('child_process');
  const dashboardPath = path.join(__dirname, '..', 'node_modules', '.bin', 'ts-node');
  const serverPath = path.join(__dirname, '..', 'src', 'dashboard', 'index.ts');
  
  const child = spawn('node', [dashboardPath, serverPath], {
    stdio: 'inherit',
    cwd: projectPath,
    env: { ...process.env, OBSERVER_PROJECT_PATH: projectPath }
  });
  
  child.on('exit', (code) => {
    process.exit(code || 0);
  });
  
  child.on('error', (error) => {
    console.error('❌ Failed to start dashboard:', error.message);
    process.exit(1);
  });
  
} else if (watchMode) {
  // Run the observer for continuous monitoring
  console.log('🔍 Starting continuous monitoring...');
  const observerPath = path.join(__dirname, 'ai-observe');
  const child = spawn('node', [observerPath], {
    stdio: 'inherit',
    cwd: projectPath,
    env: { ...process.env, OBSERVER_PROJECT_PATH: projectPath }
  });
  
  child.on('exit', (code) => {
    process.exit(code || 0);
  });
} else {
  // Run one-time analysis
  process.env.OBSERVER_PROJECT_PATH = projectPath;
  require(path.join(__dirname, '..', 'dist', 'cli', 'analyze-smart.js'));
}