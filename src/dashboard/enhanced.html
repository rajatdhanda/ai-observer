<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Observer - Unified Control Center</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e2e8f0;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .project-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Mode Selector Bar */
    .mode-bar {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .quick-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 16px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .mode-description {
      color: #64748b;
      font-size: 13px;
      margin-left: auto;
    }
    
    /* Control Bar */
    .control-bar {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }
    
    .control-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .control-right {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #64748b;
    }
    
    .run-button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .run-button:hover {
      background: #1d4ed8;
    }
    
    .run-button:disabled {
      background: #374151;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .auto-refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: #252525;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .auto-refresh-toggle.active {
      background: #059669;
      color: white;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }
    
    .status-dot.running {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }
    
    .status-dot.error {
      background: #ef4444;
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .changes-badge {
      background: #f59e0b;
      color: #000;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Tabs */
    .tabs {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      display: flex;
      padding: 10px 20px;
      align-items: center;
      gap: 15px;
      overflow-x: auto;
    }
    
    .tab-group {
      display: flex;
      gap: 5px;
    }
    
    .tab-divider {
      width: 1px;
      height: 30px;
      background: #333;
      opacity: 0.5;
      flex-shrink: 0;
    }
    
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-size: 13px;
      white-space: nowrap;
      border-radius: 6px 6px 0 0;
    }
    
    .tab:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
    }
    
    .tab.active {
      border-bottom-color: #667eea;
      background: #252525;
    }
    
    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 165px); /* Adjusted for control bar */
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      overflow-y: auto;
      padding: 20px;
    }
    
    .sidebar h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    .entity-list {
      margin-bottom: 24px;
    }
    
    .entity-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .entity-item:hover {
      background: #252525;
    }
    
    .entity-item.active {
      background: #667eea20;
      color: #667eea;
    }
    
    .entity-meta {
      font-size: 11px;
      color: #64748b;
    }
    
    .health-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .health-good { background: #10b981; }
    .health-warning { background: #f59e0b; }
    .health-error { background: #ef4444; }
    
    /* Content Area */
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    /* Detail Panel */
    .detail-panel {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: #0a0a0a;
    }
    
    .detail-header {
      margin-bottom: 30px;
    }
    
    .detail-title {
      font-size: 28px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .type-badge {
      font-size: 12px;
      padding: 4px 12px;
      background: #667eea20;
      color: #667eea;
      border-radius: 20px;
      font-weight: 500;
    }
    
    /* Properties Section */
    .section {
      margin-bottom: 32px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #333;
    }
    
    .section-title {
      font-size: 16px;
      margin-bottom: 16px;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .property-item {
      padding: 8px 12px;
      background: #0f0f0f;
      border-radius: 6px;
      border: 1px solid #252525;
      font-size: 13px;
    }
    
    .property-name {
      color: #94a3b8;
      margin-bottom: 2px;
    }
    
    .property-type {
      color: #667eea;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
    }
    
    .required {
      color: #ef4444;
      font-size: 11px;
      margin-left: 4px;
    }
    
    /* Relationships */
    .relationship-item {
      padding: 12px;
      background: #0f0f0f;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #252525;
    }
    
    .relationship-arrow {
      color: #64748b;
    }
    
    .relationship-target {
      color: #667eea;
      font-weight: 500;
    }
    
    /* Query Panel */
    .query-panel {
      width: 450px;
      background: #1a1a1a;
      border-left: 1px solid #333;
      padding: 20px;
      overflow-y: auto;
      display: none; /* Hidden by default, shown only when table selected in overview */
    }
    
    .query-box {
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .query-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #e2e8f0;
    }
    
    .query-code {
      background: #000;
      border: 1px solid #252525;
      border-radius: 4px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      color: #64d86b;
      margin-bottom: 12px;
      overflow-x: auto;
    }
    
    .response-preview {
      background: #000;
      border: 1px solid #252525;
      border-radius: 4px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      color: #94a3b8;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .query-meta {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 12px;
      color: #64748b;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-success { color: #10b981; }
    .status-error { color: #ef4444; }
    .status-warning { color: #f59e0b; }
    
    /* Flow Visualization */
    .flow-container {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #0f0f0f;
      border-radius: 8px;
      overflow-x: auto;
    }
    
    .flow-step {
      padding: 8px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .flow-step.active {
      background: #667eea20;
      border-color: #667eea;
      color: #667eea;
    }
    
    .flow-arrow {
      color: #64748b;
    }
    
    /* Usage Stats */
    .usage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    
    .usage-stat {
      background: #0f0f0f;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #252525;
    }
    
    .usage-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 4px;
    }
    
    .usage-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
    }
    
    /* Health Score */
    .health-score {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #0f0f0f;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .score-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .score-high { background: #10b98120; color: #10b981; border: 2px solid #10b981; }
    .score-medium { background: #f59e0b20; color: #f59e0b; border: 2px solid #f59e0b; }
    .score-low { background: #ef444420; color: #ef4444; border: 2px solid #ef4444; }
    
    .score-details {
      flex: 1;
    }
    
    .score-title {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    
    .score-items {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .check-item {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #252525;
    }
    
    .check-pass { color: #10b981; }
    .check-fail { color: #ef4444; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>🔍 AI Observer - Unified Control Center</h1>
    <div class="project-info">
      <span>Project: <strong id="projectName">loading...</strong></span>
      <span>Framework: <strong id="frameworkName">loading...</strong></span>
      <span>Tables: <strong id="tableCount">0</strong></span>
      <select id="projectSelector" onchange="switchProject(this.value)" style="margin-left: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 4px 8px; border-radius: 4px;">
        <option value="">Select Project</option>
        <option value="/Users/rajatdhanda/Tech/Projects/ai-observer">AI Observer</option>
        <option value="/Users/rajatdhanda/Tech/Projects/streax">Streax</option>
        <option value="test-projects/streax">Streax (test)</option>
      </select>
    </div>
  </div>

  <!-- Quick Actions Bar -->
  <div class="mode-bar" style="padding: 8px 20px; background: rgba(0,0,0,0.5); border-bottom: 1px solid #252525;">
    <div class="quick-actions" style="display: flex; gap: 10px; align-items: center;">
      <button class="action-btn" onclick="runAllValidations()" style="padding: 6px 12px; font-size: 13px;">
        <span>🚀</span> Run All
      </button>
      <button class="action-btn" onclick="exportReport()" style="padding: 6px 12px; font-size: 13px;">
        <span>📊</span> Export
      </button>
      <button class="action-btn" onclick="runContractTests()" style="padding: 6px 12px; font-size: 13px; background: #8b5cf6;">
        <span>🧪</span> Test Contracts
      </button>
      <button class="action-btn" onclick="viewChanges()" style="padding: 6px 12px; font-size: 13px;">
        <span>📝</span> Changes
      </button>
      <div style="margin-left: auto; color: #64748b; font-size: 12px;">
        <span id="lastRunStatus">Last run: Never</span>
      </div>
    </div>
  </div>

  <!-- Control Bar -->
  <div class="control-bar">
    <div class="control-left">
      <button class="run-button" id="runButton" onclick="runAnalysis()">
        ▶ Run Now
      </button>
      <div class="auto-refresh-toggle" id="autoRefreshToggle" onclick="toggleAutoRefresh()">
        <span id="autoRefreshIcon">⟲</span>
        <span id="autoRefreshText">Auto-run OFF</span>
      </div>
      <div id="changesIndicator" style="display: none;">
        <span class="changes-badge" id="changesBadge">0 changes</span>
      </div>
    </div>
    <div class="control-right">
      <div class="status-indicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Ready</span>
      </div>
      <span id="lastRunTime">Never run</span>
      <span style="opacity: 0.5;">|</span>
      <span id="projectPath" style="font-size: 11px; opacity: 0.7;">test-projects/streax</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs" style="overflow-x: auto; white-space: nowrap; padding: 0 20px;">
    <!-- Main Views -->
    <div class="tab-group">
      <div class="tab active" onclick="switchTab('overview')">🏠 Overview</div>
      <div class="tab" onclick="switchTab('unified')" style="background: #8b5cf6;">🎯 Unified</div>
      <div class="tab" onclick="switchTab('code-quality')">✅ Code Quality</div>
      <div class="tab" onclick="switchTab('contracts')">📋 Contracts</div>
      <div class="tab" onclick="switchTab('business')">🧠 Business Logic</div>
      <div class="tab" onclick="switchTab('design')">🎨 Design System</div>
      <div class="tab" onclick="switchTab('contract-tests')">🧪 Tests</div>
      <div class="tab" onclick="switchTab('export')">📤 Export</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Search -->
      <input type="text" placeholder="Search tables..." style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #e2e8f0; margin-bottom: 20px;">
      
      <!-- Tables List -->
      <div class="entity-list">
        <h3>Tables (<span id="tableListCount">0</span>)</h3>
        <div id="tablesList"></div>
      </div>
      
      <!-- Hooks List -->
      <div class="entity-list">
        <h3>🔗 Hooks (<span id="hookCount">0</span>)</h3>
        <div id="hooksList"></div>
      </div>
      
      <!-- Components List -->
      <div class="entity-list">
        <h3>🧩 Components (<span id="componentCount">0</span>)</h3>
        <div id="componentsList"></div>
      </div>
      
      <!-- API Routes List -->
      <div class="entity-list">
        <h3>🌐 API Routes (<span id="apiCount">0</span>)</h3>
        <div id="apisList"></div>
      </div>
      
      <!-- Pages List -->
      <div class="entity-list">
        <h3>📄 Pages (<span id="pageCount">0</span>)</h3>
        <div id="pagesList"></div>
      </div>
      
      <!-- Validation Status -->
      <div class="entity-list">
        <h3>Validation Health</h3>
        <div id="validationStatus">
          <div class="entity-item" onclick="switchTab('validation')">
            <span>80-20 Checks</span>
            <span id="validationScore" class="badge" style="background: #667eea;">-</span>
          </div>
          <div class="entity-item" onclick="switchTab('registry')">
            <span>Registry Score</span>
            <span id="registryScore" class="badge" style="background: #667eea;">-</span>
          </div>
        </div>
      </div>
      
      <!-- Flows -->
      <div class="entity-list">
        <h3>Data Flows</h3>
        <div id="flowsList">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content">
      <!-- Detail Panel -->
      <div class="detail-panel">
        <div id="mainContent">
          <!-- Content will be loaded here -->
        </div>
      </div>

      <!-- Query Panel (Postman-style) -->
      <div class="query-panel">
        <h3 style="font-size: 16px; margin-bottom: 20px;">🔬 Query Inspector</h3>
        
        <div id="queryContent">
          <!-- Query details will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'overview';
    let currentTable = null;
    let analysisData = {};
    // Quick action functions for daily workflow
    function runFullAnalysis() {
      // Run all core validations
      runAnalysis();
      
      // Show comprehensive overview
      switchTab('overview');
      
      // Update description
      document.getElementById('mode-description').textContent = 'Running comprehensive analysis... Check tabs below for detailed results';
    }
    let tableMapping = {};
    
    // Control bar state
    let autoRefreshEnabled = false;
    let fileChanges = 0;
    let lastChangeTime = null;
    
    // ============= SHARED COMPONENT FUNCTIONS =============
    // These reduce code duplication throughout the dashboard
    
    // Render severity counts with CORRECT labels
    function renderSeverityCounts(criticalCount, warningCount, infoCount) {
      return `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
          <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444;">
            <div style="color: #ef4444; font-size: 36px; font-weight: bold;">
              ${criticalCount}
            </div>
            <div style="color: #fca5a5; font-size: 13px; margin-top: 4px;">
              CRITICAL - Will Break Code
            </div>
            <div style="color: #64748b; font-size: 11px; margin-top: 8px;">
              Type errors, contract violations, missing imports
            </div>
          </div>
          
          <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <div style="color: #f59e0b; font-size: 36px; font-weight: bold;">
              ${warningCount}
            </div>
            <div style="color: #fcd34d; font-size: 13px; margin-top: 4px;">
              WARNINGS - Should Fix
            </div>
            <div style="color: #64748b; font-size: 11px; margin-top: 8px;">
              Missing error handling, no loading states
            </div>
          </div>
          
          <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <div style="color: #3b82f6; font-size: 36px; font-weight: bold;">
              ${infoCount}
            </div>
            <div style="color: #93bbfe; font-size: 13px; margin-top: 4px;">
              INFO - Nice to Have
            </div>
            <div style="color: #64748b; font-size: 11px; margin-top: 8px;">
              Optimizations, code style improvements
            </div>
          </div>
        </div>
      `;
    }
    
    // Calculate health score with CORRECT weights
    function calculateHealthScore(criticalCount, warningCount, infoCount = 0) {
      let score = 100;
      score -= criticalCount * 30;  // Critical issues = major penalty
      score -= warningCount * 10;   // Warnings = minor penalty  
      score -= infoCount * 2;        // Info = tiny penalty
      return Math.max(0, score);
    }
    
    // Get color based on health score
    function getHealthColor(score) {
      if (score >= 90) return '#10b981';  // Green
      if (score >= 70) return '#f59e0b';  // Yellow
      if (score >= 50) return '#ef4444';  // Red
      return '#991b1b';  // Dark red
    }
    
    // Render health score circle
    function renderHealthScore(score, size = 80) {
      const color = getHealthColor(score);
      return `
        <div style="text-align: center;">
          <div style="
            width: ${size}px;
            height: ${size}px;
            border-radius: 50%;
            background: ${color}20;
            border: 3px solid ${color};
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: ${size * 0.3}px;
            font-weight: bold;
            color: ${color};
          ">
            ${score}%
          </div>
          <div style="color: #94a3b8; font-size: 12px; margin-top: 8px;">
            Health Score
          </div>
        </div>
      `;
    }
    
    // ============= END SHARED COMPONENTS =============
    let lastRunTime = null;
    let isRunning = false;
    let autoRunTimer = null;
    let fileWatchTimer = null;

    // Control Bar Functions
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const toggle = document.getElementById('autoRefreshToggle');
      const text = document.getElementById('autoRefreshText');
      
      if (autoRefreshEnabled) {
        toggle.classList.add('active');
        text.textContent = 'Auto-run ON';
        startFileWatcher();
      } else {
        toggle.classList.remove('active');
        text.textContent = 'Auto-run OFF';
        stopFileWatcher();
      }
    }
    
    function startFileWatcher() {
      // Poll backend for file changes
      fileWatchTimer = setInterval(async () => {
        try {
          const response = await fetch('/api/file-changes');
          const data = await response.json();
          
          if (data.changes > 0) {
            fileChanges = data.changes;
            lastChangeTime = Date.now();
            updateChangesIndicator();
            
            // Check if we should auto-run
            checkAutoRun();
          }
        } catch (error) {
          console.error('Error checking file changes:', error);
        }
      }, 5000); // Check every 5 seconds
    }
    
    function stopFileWatcher() {
      if (fileWatchTimer) {
        clearInterval(fileWatchTimer);
        fileWatchTimer = null;
      }
      if (autoRunTimer) {
        clearTimeout(autoRunTimer);
        autoRunTimer = null;
      }
    }
    
    function updateChangesIndicator() {
      const indicator = document.getElementById('changesIndicator');
      const badge = document.getElementById('changesBadge');
      
      if (fileChanges > 0) {
        indicator.style.display = 'block';
        badge.textContent = `${fileChanges} change${fileChanges > 1 ? 's' : ''}`;
      } else {
        indicator.style.display = 'none';
      }
    }
    
    function checkAutoRun() {
      if (!autoRefreshEnabled || isRunning) return;
      
      // Clear existing timer
      if (autoRunTimer) {
        clearTimeout(autoRunTimer);
      }
      
      // Set timer to run after 30 seconds of no changes AND at least 3 changes
      if (fileChanges >= 3) {
        autoRunTimer = setTimeout(() => {
          const timeSinceChange = Date.now() - lastChangeTime;
          if (timeSinceChange >= 30000) { // 30 seconds
            runAnalysis();
          } else {
            // Check again after remaining time
            checkAutoRun();
          }
        }, 30000);
      }
    }
    
    async function runAnalysis() {
      if (isRunning) return;
      
      isRunning = true;
      fileChanges = 0;
      updateChangesIndicator();
      updateStatus('running', 'Running analysis...');
      
      const button = document.getElementById('runButton');
      button.disabled = true;
      button.innerHTML = '⟳ Running...';
      
      try {
        // Run all analyses based on current tab
        switch(currentTab) {
          case 'code-quality':
            await loadCodeQuality();
            break;
          case 'contracts':
            await loadContracts();
            break;
          case 'business':
            await loadBusiness();
            break;
          case 'design':
            await loadDesignSystem();
            break;
          case 'overview':
          default:
            // Run general analysis
            await fetch('/api/validate');
            await loadOverview();
        }
        
        lastRunTime = Date.now();
        updateLastRunTime();
        updateStatus('success', 'Analysis complete');
        
      } catch (error) {
        console.error('Analysis error:', error);
        updateStatus('error', 'Analysis failed');
      } finally {
        isRunning = false;
        button.disabled = false;
        button.innerHTML = '▶ Run Now';
      }
    }
    
    function updateStatus(status, text) {
      const dot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      dot.className = 'status-dot';
      if (status === 'running') {
        dot.classList.add('running');
      } else if (status === 'error') {
        dot.classList.add('error');
      }
      
      statusText.textContent = text;
    }
    
    function updateLastRunTime() {
      const element = document.getElementById('lastRunTime');
      if (!lastRunTime) {
        element.textContent = 'Never run';
        return;
      }
      
      const updateTime = () => {
        const diff = Date.now() - lastRunTime;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
          element.textContent = `${hours}h ago`;
        } else if (minutes > 0) {
          element.textContent = `${minutes}m ago`;
        } else {
          element.textContent = `${seconds}s ago`;
        }
      };
      
      updateTime();
      // Update every minute
      setInterval(updateTime, 60000);
    }
    
    // Initialize
    async function switchProject(projectName) {
      if (!projectName) return;
      
      // Clear current data
      analysisData = {};
      tableMapping = {};
      
      // Load new project data
      try {
        // Switch project on server
        await fetch(`/api/set-project?path=${encodeURIComponent(projectName)}`);
        
        // Reload everything
        await init();
      } catch (error) {
        console.error('Error switching project:', error);
      }
    }

    async function loadValidationScores() {
      try {
        const res = await fetch('/api/validate');
        const validation = await res.json();
        
        // Update validation score
        const validationScore = document.getElementById('validationScore');
        if (validationScore && validation.score !== undefined) {
          validationScore.textContent = validation.score + '%';
          validationScore.style.background = validation.score >= 80 ? '#10b981' : 
                                           validation.score >= 50 ? '#f59e0b' : '#ef4444';
        }
        
        // Update registry score
        const registryScore = document.getElementById('registryScore');
        if (registryScore && validation.registryValidation && validation.registryValidation.score !== undefined) {
          registryScore.textContent = validation.registryValidation.score + '%';
          registryScore.style.background = validation.registryValidation.score >= 80 ? '#10b981' : 
                                          validation.registryValidation.score >= 50 ? '#f59e0b' : '#ef4444';
        }
      } catch (error) {
        console.error('Error loading validation scores:', error);
      }
    }

    // Contract Testing Functions
    async function runContractTests() {
      showLogPanel('Running contract tests...');
      
      try {
        const response = await fetch('/api/run-tests');
        const results = await response.json();
        
        showLogPanel(`Tests completed: ${results.summary.passed}/${results.summary.total} passed`);
        
        // Show results in main panel
        displayContractTestResults(results);
        
        // Switch to tests tab
        switchTab('contract-tests');
        
      } catch (error) {
        showLogPanel(`Error running tests: ${error.message}`, 'error');
      }
    }
    
    function displayContractTestResults(results) {
      const mainContent = document.getElementById('mainContent');
      
      const summaryColor = results.summary.passed === results.summary.total ? '#10b981' :
                          results.summary.passed > results.summary.total / 2 ? '#f59e0b' : '#ef4444';
      
      mainContent.innerHTML = `
        <div style="padding: 20px;">
          <h2 style="color: #f8fafc; margin-bottom: 20px;">🧪 Contract Test Results</h2>
          
          <!-- Summary -->
          <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold; color: ${summaryColor};">
                  ${results.summary.passed}/${results.summary.total}
                </div>
                <div style="color: #64748b; font-size: 12px;">Tests Passed</div>
              </div>
              <div style="flex: 1;">
                <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                  <span style="color: #10b981;">✅ Passed: ${results.summary.passed}</span>
                  <span style="color: #ef4444;">❌ Failed: ${results.summary.failed}</span>
                  <span style="color: #64748b;">⏭️ Skipped: ${results.summary.skipped}</span>
                </div>
                <div style="color: #64748b; font-size: 12px;">Duration: ${results.summary.duration}ms</div>
              </div>
            </div>
          </div>
          
          <!-- Recommendations -->
          ${results.recommendations.length > 0 ? `
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #f8fafc; margin-bottom: 15px;">📋 Recommendations</h3>
              ${results.recommendations.map(rec => `
                <div style="padding: 8px 0; color: #e2e8f0; font-size: 14px;">
                  ${rec}
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <!-- Test Suites -->
          ${results.suites.map(suite => `
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #f8fafc; margin-bottom: 15px;">${suite.name}</h3>
              ${suite.results.map(test => `
                <div style="padding: 10px; margin-bottom: 10px; background: #0a0a0a; border-radius: 4px; border-left: 3px solid ${
                  test.status === 'pass' ? '#10b981' : 
                  test.status === 'fail' ? '#ef4444' : 
                  test.status === 'skip' ? '#64748b' : '#f59e0b'
                };">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: #f8fafc; font-weight: 500;">${test.name}</span>
                    <span style="color: ${
                      test.status === 'pass' ? '#10b981' : 
                      test.status === 'fail' ? '#ef4444' : 
                      test.status === 'skip' ? '#64748b' : '#f59e0b'
                    }; font-size: 12px;">
                      ${test.status.toUpperCase()} (${test.duration}ms)
                    </span>
                  </div>
                  ${test.error ? `
                    <div style="color: #ef4444; font-size: 12px; margin-top: 8px;">
                      Error: ${test.error}
                    </div>
                  ` : ''}
                  ${test.assertions && test.assertions.length > 0 ? `
                    <div style="margin-top: 10px;">
                      ${test.assertions.filter(a => !a.passed).map(assertion => `
                        <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; margin-top: 5px;">
                          <div style="color: #ef4444; font-size: 11px;">
                            ❌ ${assertion.description}
                          </div>
                          <div style="color: #64748b; font-size: 11px; margin-top: 4px;">
                            Expected: ${JSON.stringify(assertion.expected)} | Actual: ${JSON.stringify(assertion.actual)}
                          </div>
                          ${assertion.message ? `
                            <div style="color: #94a3b8; font-size: 11px; margin-top: 4px;">
                              ${assertion.message}
                            </div>
                          ` : ''}
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          `).join('')}
        </div>
      `;
    }
    
    async function loadUnifiedView() {
      showLogPanel('Loading unified report...');
      
      try {
        const response = await fetch('/api/unified-report');
        const report = await response.json();
        
        const mainContent = document.getElementById('mainContent');
        const healthColor = report.healthScore >= 90 ? '#10b981' :
                           report.healthScore >= 70 ? '#f59e0b' : '#ef4444';
        const healthLabel = report.healthScore >= 90 ? 'Healthy' :
                           report.healthScore >= 70 ? 'Needs Attention' :
                           report.healthScore >= 50 ? 'Critical Issues' :
                           'BROKEN - Fix Immediately!';
        
        mainContent.innerHTML = `
          <div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
            <!-- Main Status Banner -->
            <div style="background: ${report.summary.willBreak ? '#7f1d1d' : '#1a1a1a'}; 
                        padding: 30px; 
                        border-radius: 12px; 
                        margin-bottom: 30px;
                        border: 2px solid ${report.summary.willBreak ? '#ef4444' : '#333'};">
              
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h1 style="color: #f8fafc; margin: 0; font-size: 32px;">
                    ${report.summary.willBreak ? '🚨 YOUR CODE WILL BREAK!' : '✅ Code is Stable'}
                  </h1>
                  <p style="color: ${report.summary.willBreak ? '#fca5a5' : '#94a3b8'}; 
                            margin-top: 10px; 
                            font-size: 18px;">
                    ${report.summary.topPriority}
                  </p>
                </div>
                
                <div style="text-align: center;">
                  <div style="font-size: 48px; 
                              font-weight: bold; 
                              color: ${healthColor};">
                    ${report.healthScore}%
                  </div>
                  <div style="color: #94a3b8; font-size: 14px;">${healthLabel}</div>
                </div>
              </div>

              <!-- Quick Stats -->
              <div style="display: grid; 
                          grid-template-columns: repeat(3, 1fr); 
                          gap: 20px; 
                          margin-top: 30px;">
                
                <div style="background: rgba(239, 68, 68, 0.1); 
                            padding: 15px; 
                            border-radius: 8px; 
                            border: 1px solid rgba(239, 68, 68, 0.3);">
                  <div style="color: #ef4444; font-size: 24px; font-weight: bold;">
                    ${report.summary.criticalCount}
                  </div>
                  <div style="color: #fca5a5; font-size: 12px;">
                    WILL BREAK CODE
                  </div>
                </div>

                <div style="background: rgba(245, 158, 11, 0.1); 
                            padding: 15px; 
                            border-radius: 8px; 
                            border: 1px solid rgba(245, 158, 11, 0.3);">
                  <div style="color: #f59e0b; font-size: 24px; font-weight: bold;">
                    ${report.summary.warningCount}
                  </div>
                  <div style="color: #fcd34d; font-size: 12px;">
                    Should Fix
                  </div>
                </div>

                <div style="background: rgba(59, 130, 246, 0.1); 
                            padding: 15px; 
                            border-radius: 8px; 
                            border: 1px solid rgba(59, 130, 246, 0.3);">
                  <div style="color: #3b82f6; font-size: 24px; font-weight: bold;">
                    ${report.summary.infoCount}
                  </div>
                  <div style="color: #93bbfe; font-size: 12px;">
                    Nice to Have
                  </div>
                </div>
              </div>
            </div>

            <!-- Critical Issues (if any) -->
            ${report.criticalIssues.length > 0 ? `
              <div style="background: #1a1a1a; 
                          padding: 20px; 
                          border-radius: 8px; 
                          margin-bottom: 20px;
                          border-left: 4px solid #ef4444;">
                <h2 style="color: #ef4444; margin: 0 0 20px 0;">
                  🚨 Critical Issues - FIX IMMEDIATELY
                </h2>
                
                ${report.criticalIssues.slice(0, 10).map(issue => `
                  <div style="background: #0a0a0a; 
                              padding: 15px; 
                              border-radius: 6px; 
                              margin-bottom: 10px;">
                    <div style="display: flex; 
                                align-items: start; 
                                justify-content: space-between;">
                      <div style="flex: 1;">
                        <div style="color: #f8fafc; 
                                    font-weight: 500; 
                                    margin-bottom: 5px;">
                          ${issue.message}
                        </div>
                        <div style="color: #64748b; 
                                    font-size: 12px; 
                                    font-family: monospace;">
                          ${issue.file}${issue.line ? ':' + issue.line : ''}
                        </div>
                        ${issue.fix ? `
                          <div style="color: #10b981; 
                                      font-size: 13px; 
                                      margin-top: 8px;">
                            💡 Fix: ${issue.fix}
                          </div>
                        ` : ''}
                      </div>
                      <span style="background: #ef4444; 
                                   color: white; 
                                   padding: 2px 8px; 
                                   border-radius: 4px; 
                                   font-size: 11px;">
                        ${issue.source.toUpperCase()}
                      </span>
                    </div>
                  </div>
                `).join('')}
                
                ${report.criticalIssues.length > 10 ? `
                  <div style="color: #ef4444; 
                              text-align: center; 
                              margin-top: 10px; 
                              font-size: 14px;">
                    ... and ${report.criticalIssues.length - 10} more critical issues
                  </div>
                ` : ''}
              </div>
            ` : ''}

            <!-- Warnings -->
            ${report.warnings.length > 0 ? `
              <div style="background: #1a1a1a; 
                          padding: 20px; 
                          border-radius: 8px; 
                          margin-bottom: 20px;
                          border-left: 4px solid #f59e0b;">
                <h2 style="color: #f59e0b; margin: 0 0 20px 0;">
                  ⚠️ Warnings - Should Fix
                </h2>
                
                ${report.warnings.slice(0, 5).map(issue => `
                  <div style="background: #0a0a0a; 
                              padding: 12px; 
                              border-radius: 6px; 
                              margin-bottom: 8px;">
                    <div style="color: #e2e8f0; font-size: 14px;">
                      ${issue.message}
                    </div>
                    <div style="color: #64748b; 
                                font-size: 11px; 
                                margin-top: 4px;">
                      ${issue.file}
                    </div>
                  </div>
                `).join('')}
                
                ${report.warnings.length > 5 ? `
                  <div style="color: #94a3b8; 
                              text-align: center; 
                              margin-top: 10px; 
                              font-size: 13px;">
                    + ${report.warnings.length - 5} more warnings
                  </div>
                ` : ''}
              </div>
            ` : ''}

            <!-- Action Button -->
            <div style="text-align: center; margin-top: 30px;">
              ${report.summary.willBreak ? `
                <button onclick="alert('Auto-fix not yet implemented')" 
                        style="padding: 15px 30px; 
                               background: #ef4444; 
                               border: none; 
                               border-radius: 8px; 
                               color: white; 
                               font-size: 16px; 
                               font-weight: bold; 
                               cursor: pointer;">
                  🔧 Auto-Fix Critical Issues
                </button>
              ` : `
                <button onclick="runAllValidations()" 
                        style="padding: 15px 30px; 
                               background: #10b981; 
                               border: none; 
                               border-radius: 8px; 
                               color: white; 
                               font-size: 16px; 
                               cursor: pointer;">
                  ✅ All Good - Run Full Check
                </button>
              `}
            </div>
          </div>
        `;
        
        showLogPanel('Unified report loaded');
      } catch (error) {
        showLogPanel(`Error loading unified report: ${error.message}`, 'error');
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
          <div style="padding: 20px; color: #ef4444;">
            <h2>Error Loading Unified Report</h2>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    async function loadContractTests() {
      showLogPanel('Loading contract test results...');
      
      try {
        // Load table-contract validation
        const validationResponse = await fetch('/api/table-contract-validation');
        const validationData = await validationResponse.json();
        
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="color: #f8fafc; margin-bottom: 20px;">📋 Table-Contract Validation</h2>
            
            <!-- Summary -->
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${validationData.summary.totalTables}</div>
                  <div style="color: #64748b; font-size: 12px;">Total Tables</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; color: #10b981;">${validationData.summary.tablesWithContracts}</div>
                  <div style="color: #64748b; font-size: 12px;">With Contracts</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${validationData.summary.tablesWithoutContracts}</div>
                  <div style="color: #64748b; font-size: 12px;">Missing Contracts</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; color: ${
                    validationData.summary.overallScore >= 80 ? '#10b981' :
                    validationData.summary.overallScore >= 60 ? '#f59e0b' : '#ef4444'
                  };">${validationData.summary.overallScore}%</div>
                  <div style="color: #64748b; font-size: 12px;">Overall Score</div>
                </div>
              </div>
            </div>
            
            <!-- Table Details -->
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
              <h3 style="color: #f8fafc; margin-bottom: 15px;">Table Validation Details</h3>
              ${validationData.results.sort((a, b) => a.score - b.score).map(result => `
                <div style="padding: 15px; margin-bottom: 10px; background: #0a0a0a; border-radius: 4px; border-left: 3px solid ${
                  result.score >= 80 ? '#10b981' :
                  result.score >= 60 ? '#f59e0b' : '#ef4444'
                };">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #f8fafc; font-weight: 500; font-size: 16px;">${result.table}</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="color: #64748b; font-size: 12px;">Contract: ${result.contract}</span>
                      <span style="color: ${
                        result.score >= 80 ? '#10b981' :
                        result.score >= 60 ? '#f59e0b' : '#ef4444'
                      }; font-weight: bold;">${result.score}%</span>
                    </div>
                  </div>
                  ${result.recommendation ? `
                    <div style="color: #94a3b8; font-size: 13px; margin-bottom: 10px;">
                      💡 ${result.recommendation}
                    </div>
                  ` : ''}
                  ${result.validations.filter(v => v.status !== 'pass').slice(0, 3).map(validation => `
                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; margin-top: 5px;">
                      <span style="color: ${validation.status === 'fail' ? '#ef4444' : '#f59e0b'}; font-size: 11px;">
                        ${validation.status === 'fail' ? '❌' : '⚠️'} ${validation.message}
                      </span>
                      ${validation.details ? `
                        <div style="color: #64748b; font-size: 10px; margin-top: 4px;">
                          ${validation.details.suggestion || ''}
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                  ${result.validations.filter(v => v.status !== 'pass').length > 3 ? `
                    <div style="color: #64748b; font-size: 11px; margin-top: 5px;">
                      ... and ${result.validations.filter(v => v.status !== 'pass').length - 3} more issues
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
              <button onclick="runContractTests()" style="padding: 10px 20px; background: #8b5cf6; border: none; border-radius: 6px; color: white; cursor: pointer;">
                🧪 Run Full Test Suite
              </button>
            </div>
          </div>
        `;
        
        showLogPanel('Contract validation loaded');
      } catch (error) {
        showLogPanel(`Error loading contract tests: ${error.message}`, 'error');
      }
    }

    async function init() {
      try {
        // First try to get analysis data
        const analysisRes = await fetch('/api/analysis');
        if (analysisRes.ok) {
          const data = await analysisRes.text();
          if (data && data !== '{}') {
            analysisData = JSON.parse(data);
          }
        }
        
        // Load table mapping - this is the important one
        const mappingRes = await fetch('/api/table-mapping');
        if (mappingRes.ok) {
          tableMapping = await mappingRes.json();
        }
        
        // If no analysis data, try to analyze first
        if (!analysisData || Object.keys(analysisData).length === 0) {
          // Get current project from server
          const projectRes = await fetch('/api/projects');
          const projectData = await projectRes.json();
          const currentProject = projectData.current || 'ai-observer';
          
          const analyzeRes = await fetch(`/api/analyze?project=${encodeURIComponent(currentProject)}`);
          if (analyzeRes.ok) {
            analysisData = await analyzeRes.json();
          }
        }
        
        // Update header with available data
        const projectName = analysisData?.projectName || tableMapping?.projectInfo?.name || 'Streax';
        document.getElementById('projectName').textContent = projectName;
        document.getElementById('frameworkName').textContent = 
          analysisData?.framework?.name || tableMapping?.projectInfo?.framework || 'TypeScript';
        document.getElementById('tableCount').textContent = 
          Object.keys(tableMapping?.tables || analysisData?.tables || {}).length;
          
        // Update project selector
        const selector = document.getElementById('projectSelector');
        if (selector) {
          // Try to find the matching option
          const projectRes = await fetch('/api/projects');
          const projectInfo = await projectRes.json();
          if (projectInfo.current) {
            // Set selector to current project path
            for (let option of selector.options) {
              if (option.value === projectInfo.current) {
                selector.value = projectInfo.current;
                break;
              }
            }
          }
        }
        
        // Load sidebar
        loadSidebar();
        
        // Load validation scores
        loadValidationScores();
        
        // Load initial content
        loadOverview();
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function loadSidebar() {
      // Try to get tables from multiple sources
      const tablesData = tableMapping?.tables || analysisData?.tables || {};
      const tables = Object.entries(tablesData);
      const tablesList = document.getElementById('tablesList');
      
      if (tables.length === 0) {
        tablesList.innerHTML = `
          <div style="color: #64748b; padding: 10px; font-size: 12px;">
            No tables found. Try analyzing a project with database tables.
          </div>
        `;
      } else {
        tablesList.innerHTML = tables.map(([name, table]) => {
        const healthClass = table.score >= 80 ? 'health-good' : 
                           table.score >= 40 ? 'health-warning' : 'health-error';
        return `
          <div class="entity-item" onclick="selectTable('${name}')">
            <span>${name}</span>
            <div>
              <span class="entity-meta">${table.score}%</span>
              <span class="health-indicator ${healthClass}"></span>
            </div>
          </div>
        `;
      }).join('');
      }
      
      document.getElementById('tableListCount').textContent = tables.length;
      
      // Load hooks from tables
      const hooks = tables.flatMap(([_, table]) => table.hooks || []);
      const uniqueHooks = [...new Set(hooks.map(h => h.hookName))];
      document.getElementById('hookCount').textContent = uniqueHooks.length;
      
      // Populate architecture counts from existing components
      populateArchitectureCounts();
      
      const hooksList = document.getElementById('hooksList');
      hooksList.innerHTML = uniqueHooks.slice(0, 10).map(hook => {
        // Find which tables use this hook
        const tablesUsingHook = tables.filter(([_, table]) => 
          table.hooks?.some(h => h.hookName === hook)
        ).map(([name]) => name);
        
        return `
          <div class="entity-item" onclick="showHookDetails('${hook}')" style="cursor: pointer;">
            <span>${hook}</span>
            <span class="entity-meta" style="font-size: 10px;">${tablesUsingHook.length} tables</span>
          </div>
        `;
      }).join('');
      
      // Load flows dynamically
      loadDataFlows(tables);
    }
    
    async function populateArchitectureCounts() {
      // Use proper server-side API with same logic as working dashboard tabs
      try {
        // Get data from server using same validation logic as tabs
        const [hooksRes, componentsRes, apisRes, pagesRes] = await Promise.all([
          fetch('/api/architecture-data?type=hook'),
          fetch('/api/architecture-data?type=component'),
          fetch('/api/architecture-data?type=api'),
          fetch('/api/architecture-data?type=page')
        ]);
        
        const [hooks, components, apis, pages] = await Promise.all([
          hooksRes.json(),
          componentsRes.json(),
          apisRes.json(),
          pagesRes.json()
        ]);
        
        // Update counts
        document.getElementById('hookCount').textContent = hooks.length;
        document.getElementById('componentCount').textContent = components.length;
        document.getElementById('apiCount').textContent = apis.length;
        document.getElementById('pageCount').textContent = pages.length;
        
        // Populate lists with clickable items using correct data
        populateArchitectureList('hooksList', hooks, 'hook');
        populateArchitectureList('componentsList', components, 'component');
        populateArchitectureList('apisList', apis, 'api');
        populateArchitectureList('pagesList', pages, 'page');
        
      } catch (error) {
        console.error('Error getting architecture counts:', error);
        // Fallback to show error counts are empty
        document.getElementById('hookCount').textContent = '0';
        document.getElementById('componentCount').textContent = '0';
        document.getElementById('apiCount').textContent = '0';
        document.getElementById('pageCount').textContent = '0';
      }
    }


    function populateArchitectureList(listId, items, itemType) {
      const listElement = document.getElementById(listId);
      if (!listElement) return;
      
      if (items.length === 0) {
        listElement.innerHTML = `
          <div style="color: #64748b; padding: 10px; font-size: 12px; text-align: center;">
            No ${itemType}s found
          </div>
        `;
        return;
      }
      
      listElement.innerHTML = items.slice(0, 10).map(item => {
        const healthClass = item.healthScore >= 80 ? 'health-good' : 
                           item.healthScore >= 40 ? 'health-warning' : 'health-error';
        
        return `
          <div class="entity-item" onclick="selectArchitectureItem('${item.name}', '${itemType}', '${item.file}')" style="cursor: pointer;">
            <span>${item.name}</span>
            <div>
              <span class="entity-meta">${item.healthScore}%</span>
              <span class="health-indicator ${healthClass}"></span>
            </div>
          </div>
        `;
      }).join('');
      
      if (items.length > 10) {
        listElement.innerHTML += `
          <div style="color: #64748b; padding: 10px; font-size: 11px; text-align: center;">
            ... and ${items.length - 10} more
          </div>
        `;
      }
    }
    
    
    function loadDataFlows(tables) {
      const flowsList = document.getElementById('flowsList');
      
      // Identify common flows based on table relationships
      const flows = [];
      
      // Authentication flow
      if (tables.some(([name]) => name.toLowerCase().includes('user') || name.toLowerCase().includes('auth'))) {
        flows.push({
          name: 'Authentication',
          tables: tables.filter(([name]) => 
            name.toLowerCase().includes('user') || 
            name.toLowerCase().includes('auth') || 
            name.toLowerCase().includes('session')
          ).map(([name]) => name),
          health: 'good'
        });
      }
      
      // Content flow
      if (tables.some(([name]) => name.toLowerCase().includes('post') || name.toLowerCase().includes('comment'))) {
        flows.push({
          name: 'Content Management',
          tables: tables.filter(([name]) => 
            name.toLowerCase().includes('post') || 
            name.toLowerCase().includes('comment') || 
            name.toLowerCase().includes('engagement')
          ).map(([name]) => name),
          health: 'warning'
        });
      }
      
      // Professional/Profile flow
      if (tables.some(([name]) => name.toLowerCase().includes('professional') || name.toLowerCase().includes('profile'))) {
        flows.push({
          name: 'User Profiles',
          tables: tables.filter(([name]) => 
            name.toLowerCase().includes('professional') || 
            name.toLowerCase().includes('profile') ||
            name.toLowerCase().includes('skill')
          ).map(([name]) => name),
          health: 'good'
        });
      }
      
      // Live session flow
      if (tables.some(([name]) => name.toLowerCase().includes('live') || name.toLowerCase().includes('session'))) {
        flows.push({
          name: 'Live Sessions',
          tables: tables.filter(([name]) => 
            name.toLowerCase().includes('live') || 
            name.toLowerCase().includes('session') ||
            name.toLowerCase().includes('stream')
          ).map(([name]) => name),
          health: 'warning'
        });
      }
      
      flowsList.innerHTML = flows.map(flow => {
        const healthClass = `health-${flow.health}`;
        return `
          <div class="entity-item" onclick="showFlowDetails('${flow.name}', ${JSON.stringify(flow.tables).replace(/"/g, '&quot;')})" style="cursor: pointer;">
            <span>${flow.name}</span>
            <div>
              <span class="entity-meta" style="font-size: 10px;">${flow.tables.length} tables</span>
              <span class="health-indicator ${healthClass}"></span>
            </div>
          </div>
        `;
      }).join('') || '<div style="color: #64748b; padding: 10px; font-size: 12px;">No flows detected</div>';
    }

    function selectTable(tableName) {
      currentTable = tableName;
      const tablesData = tableMapping?.tables || analysisData?.tables || {};
      const table = tablesData[tableName];
      if (!table) {
        console.warn('Table not found:', tableName);
        return;
      }
      
      // Update active state
      document.querySelectorAll('.entity-item').forEach(el => {
        el.classList.remove('active');
        if (el.textContent.includes(tableName)) {
          el.classList.add('active');
        }
      });
      
      // Show query panel when table is selected in overview tab
      const queryPanel = document.querySelector('.query-panel');
      if (queryPanel && currentTab === 'overview') {
        queryPanel.style.display = 'block';
      }
      
      // Load table details
      loadTableDetails(tableName, table);
      
      // Load queries
      loadTableQueries(tableName, table);
    }

    function loadTableDetails(name, table) {
      // Try multiple matching strategies
      const entity = analysisData.entities?.find(e => 
        e.name.toLowerCase() === name.toLowerCase() ||
        e.name.toLowerCase() === name.toLowerCase() + 's' || // Try plural
        e.name.toLowerCase() + 's' === name.toLowerCase() || // Try singular
        e.type?.toLowerCase() === name.toLowerCase()
      ) || {};
      
      // If still no match, try to find by capitalizing first letter
      const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
      const fallbackEntity = analysisData.entities?.find(e => 
        e.name === capitalizedName
      ) || entity;
      
      const finalEntity = fallbackEntity.name ? fallbackEntity : entity;
      
      const scoreClass = table.score >= 80 ? 'score-high' : 
                        table.score >= 40 ? 'score-medium' : 'score-low';
      
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <!-- Header -->
        <div class="detail-header">
          <div class="detail-title">
            ${name}
            <span class="type-badge">${finalEntity.type || 'table'}</span>
          </div>
          <div style="color: #64748b; font-size: 14px;">
            ${table.typeDefinition?.file || 'No type definition'}
          </div>
        </div>

        <!-- Health Score -->
        <div class="health-score">
          <div class="score-circle ${scoreClass}">${table.score}%</div>
          <div class="score-details">
            <div class="score-title">Health Score</div>
            <div class="score-items">
              ${table.typeDefinition ? '<span class="check-item check-pass">✓ Type</span>' : '<span class="check-item check-fail">✗ Type</span>'}
              ${table.typeDefinition?.hasZodSchema ? '<span class="check-item check-pass">✓ Validation</span>' : '<span class="check-item check-fail">✗ Validation</span>'}
              ${table.hooks.length > 0 ? '<span class="check-item check-pass">✓ Hooks</span>' : '<span class="check-item check-fail">✗ Hooks</span>'}
              ${table.components.length > 0 ? '<span class="check-item check-pass">✓ UI</span>' : '<span class="check-item check-fail">✗ UI</span>'}
              ${table.apiEndpoints.length > 0 ? '<span class="check-item check-pass">✓ API</span>' : '<span class="check-item check-fail">✗ API</span>'}
            </div>
          </div>
        </div>

        <!-- Properties -->
        <div class="section">
          <div class="section-title">📝 Properties (${finalEntity.properties?.length || 0})</div>
          <div class="properties-grid">
            ${(finalEntity.properties || []).slice(0, 12).map(prop => `
              <div class="property-item">
                <div class="property-name">
                  ${prop.name}
                  ${prop.required ? '<span class="required">*</span>' : ''}
                </div>
                <div class="property-type">${prop.type}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Relationships -->
        <div class="section">
          <div class="section-title">🔗 Relationships (${finalEntity.relationships?.length || 0})</div>
          ${(finalEntity.relationships || []).map(rel => `
            <div class="relationship-item">
              <span>${name}</span>
              <span class="relationship-arrow">→</span>
              <span class="relationship-target">${rel.type} ${rel.target || rel.entity}</span>
            </div>
          `).join('') || '<div style="color: #64748b;">No relationships defined</div>'}
        </div>

        <!-- Data Flow -->
        <div class="section">
          <div class="section-title">🔄 Data Flow</div>
          <div class="flow-container">
            <div class="flow-step ${table.typeDefinition ? 'active' : ''}">Type</div>
            <span class="flow-arrow">→</span>
            <div class="flow-step ${table.databaseQueries.length > 0 ? 'active' : ''}">Database</div>
            <span class="flow-arrow">→</span>
            <div class="flow-step ${table.hooks.length > 0 ? 'active' : ''}">Hooks</div>
            <span class="flow-arrow">→</span>
            <div class="flow-step ${table.components.length > 0 ? 'active' : ''}">Components</div>
            <span class="flow-arrow">→</span>
            <div class="flow-step ${table.apiEndpoints.length > 0 ? 'active' : ''}">API</div>
          </div>
        </div>

        <!-- Usage Stats -->
        <div class="section">
          <div class="section-title">📊 Usage Statistics</div>
          <div class="usage-grid">
            <div class="usage-stat">
              <div class="usage-number">${table.hooks.length}</div>
              <div class="usage-label">Hooks</div>
            </div>
            <div class="usage-stat">
              <div class="usage-number">${table.components.length}</div>
              <div class="usage-label">Components</div>
            </div>
            <div class="usage-stat">
              <div class="usage-number">${table.apiEndpoints.length}</div>
              <div class="usage-label">API Routes</div>
            </div>
            <div class="usage-stat">
              <div class="usage-number">${table.mutations.length}</div>
              <div class="usage-label">Mutations</div>
            </div>
          </div>
        </div>
      `;
    }

    function showHookDetails(hookName) {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      // Find all tables that use this hook
      const tablesData = tableMapping?.tables || analysisData?.tables || {};
      const hookUsage = [];
      
      Object.entries(tablesData).forEach(([tableName, table]) => {
        const hookInfo = table.hooks?.find(h => h.hookName === hookName);
        if (hookInfo) {
          hookUsage.push({
            table: tableName,
            hook: hookInfo,
            components: hookInfo.usedInComponents || [],
            operations: hookInfo.operations || [],
            hasError: hookInfo.hasErrorHandling,
            hasLoading: hookInfo.hasLoadingState
          });
        }
      });
      
      // Create detailed hook view
      mainContent.innerHTML = `
        <div style="padding: 20px;">
          <h2 style="margin-bottom: 20px;">🪝 Hook: ${hookName}</h2>
          
          <!-- Hook Overview -->
          <div style="background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #60a5fa; margin-bottom: 10px;">Hook Analysis</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
              <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                <div style="font-size: 24px; color: #3b82f6;">${hookUsage.length}</div>
                <div style="color: #94a3b8; font-size: 12px;">Tables Using</div>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                <div style="font-size: 24px; color: #10b981;">
                  ${hookUsage.reduce((acc, u) => acc + u.components.length, 0)}
                </div>
                <div style="color: #94a3b8; font-size: 12px;">Components</div>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                <div style="font-size: 24px; color: ${hookUsage.every(u => u.hasError) ? '#10b981' : '#ef4444'};">
                  ${hookUsage.every(u => u.hasError) ? '✅' : '❌'}
                </div>
                <div style="color: #94a3b8; font-size: 12px;">Error Handling</div>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                <div style="font-size: 24px; color: ${hookUsage.every(u => u.hasLoading) ? '#10b981' : '#f59e0b'};">
                  ${hookUsage.every(u => u.hasLoading) ? '✅' : '⚠️'}
                </div>
                <div style="color: #94a3b8; font-size: 12px;">Loading State</div>
              </div>
            </div>
          </div>
          
          <!-- Usage Details -->
          <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
            <h3 style="color: #60a5fa; margin-bottom: 15px;">Usage Trace</h3>
            ${hookUsage.map(usage => `
              <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <h4 style="color: #fbbf24; cursor: pointer;" onclick="selectTable('${usage.table}')">
                    📊 ${usage.table} →
                  </h4>
                  <div style="display: flex; gap: 10px;">
                    ${usage.hasError ? '<span style="color: #10b981;">✅ Error</span>' : '<span style="color: #ef4444;">❌ No Error</span>'}
                    ${usage.hasLoading ? '<span style="color: #10b981;">✅ Loading</span>' : '<span style="color: #f59e0b;">⚠️ No Loading</span>'}
                  </div>
                </div>
                
                <!-- Operations -->
                ${usage.operations.length > 0 ? `
                  <div style="margin-bottom: 10px;">
                    <span style="color: #94a3b8; font-size: 12px;">Operations:</span>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                      ${usage.operations.map(op => `
                        <span style="padding: 2px 8px; background: #374151; border-radius: 4px; font-size: 11px;">
                          ${op}
                        </span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
                
                <!-- Components -->
                ${usage.components.length > 0 ? `
                  <div>
                    <span style="color: #94a3b8; font-size: 12px;">Used in Components:</span>
                    <div style="margin-top: 5px;">
                      ${usage.components.map(comp => `
                        <div style="padding: 5px 10px; background: #1f2937; border-radius: 4px; margin-top: 5px; cursor: pointer;"
                             onclick="showComponentDetails('${comp}')">
                          🎨 ${comp}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : '<div style="color: #64748b; font-size: 12px;">No components found using this hook</div>'}
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      // Clear query panel
      queryContent.innerHTML = `
        <div style="padding: 20px;">
          <h3 style="color: #60a5fa; margin-bottom: 10px;">Hook Code Preview</h3>
          <div style="background: #0f172a; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
            <div style="color: #94a3b8;">// Example usage of ${hookName}</div>
            <div style="color: #e2e8f0; margin-top: 10px;">
              const { data, error, isLoading } = ${hookName}();
              <br><br>
              if (isLoading) return &lt;Skeleton /&gt;;
              <br>
              if (error) return &lt;ErrorMessage /&gt;;
              <br>
              if (!data) return null;
              <br><br>
              return &lt;DataDisplay data={data} /&gt;;
            </div>
          </div>
        </div>
      `;
    }
    
    function showFlowDetails(flowName, tables) {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      const tablesData = tableMapping?.tables || analysisData?.tables || {};
      
      // Build flow visualization
      const flowSteps = [];
      tables.forEach(tableName => {
        const table = tablesData[tableName];
        if (table) {
          flowSteps.push({
            name: tableName,
            type: table.typeDefinition ? '✅' : '❌',
            db: table.databaseQueries.length,
            hooks: table.hooks.length,
            components: table.components.length,
            score: table.score
          });
        }
      });
      
      mainContent.innerHTML = `
        <div style="padding: 20px;">
          <h2 style="margin-bottom: 20px;">🔄 Flow: ${flowName}</h2>
          
          <!-- Flow Overview -->
          <div style="background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #60a5fa; margin-bottom: 15px;">Flow Pipeline</h3>
            
            <!-- Visual Flow -->
            <div style="overflow-x: auto;">
              <div style="display: flex; gap: 20px; padding: 10px; min-width: fit-content;">
                ${flowSteps.map((step, idx) => `
                  <div style="text-align: center;">
                    <div style="padding: 15px; background: ${step.score >= 80 ? '#14532d' : step.score >= 40 ? '#78350f' : '#7f1d1d'}; 
                                border-radius: 8px; cursor: pointer; min-width: 120px;"
                         onclick="selectTable('${step.name}')">
                      <div style="font-weight: bold; margin-bottom: 10px;">${step.name}</div>
                      <div style="font-size: 24px; margin-bottom: 5px;">${step.score}%</div>
                      <div style="display: flex; justify-content: center; gap: 10px; font-size: 12px;">
                        <span>${step.type} Type</span>
                        <span>${step.hooks} 🪝</span>
                        <span>${step.components} 🎨</span>
                      </div>
                    </div>
                    ${idx < flowSteps.length - 1 ? '<div style="color: #64748b; font-size: 20px; margin-top: 10px;">↓</div>' : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <!-- Flow Health Analysis -->
          <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
            <h3 style="color: #60a5fa; margin-bottom: 15px;">Health Analysis</h3>
            
            <!-- Bottlenecks -->
            ${flowSteps.filter(s => s.score < 40).length > 0 ? `
              <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                <h4 style="color: #fca5a5; margin-bottom: 10px;">❌ Critical Issues</h4>
                ${flowSteps.filter(s => s.score < 40).map(step => `
                  <div style="margin-bottom: 5px;">
                    <span style="color: #ef4444;">• ${step.name}</span>: 
                    ${step.hooks === 0 ? 'No hooks' : ''}
                    ${step.components === 0 ? 'No UI components' : ''}
                    ${step.db === 0 ? 'No DB queries' : ''}
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <!-- Warnings -->
            ${flowSteps.filter(s => s.score >= 40 && s.score < 80).length > 0 ? `
              <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                <h4 style="color: #fcd34d; margin-bottom: 10px;">⚠️ Warnings</h4>
                ${flowSteps.filter(s => s.score >= 40 && s.score < 80).map(step => `
                  <div style="margin-bottom: 5px;">
                    <span style="color: #f59e0b;">• ${step.name}</span>: 
                    Incomplete implementation (${step.score}% health)
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <!-- Success -->
            ${flowSteps.filter(s => s.score >= 80).length > 0 ? `
              <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 4px;">
                <h4 style="color: #86efac; margin-bottom: 10px;">✅ Healthy Tables</h4>
                ${flowSteps.filter(s => s.score >= 80).map(step => `
                  <div style="margin-bottom: 5px;">
                    <span style="color: #10b981;">• ${step.name}</span>: 
                    Fully implemented (${step.score}% health)
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
      
      // Show flow diagram in query panel
      queryContent.innerHTML = `
        <div style="padding: 20px;">
          <h3 style="color: #60a5fa; margin-bottom: 15px;">Flow Trace</h3>
          <div style="background: #0f172a; padding: 15px; border-radius: 8px;">
            <div style="font-family: monospace; font-size: 12px; color: #e2e8f0;">
              ${flowSteps.map((step, idx) => `
                <div style="margin-bottom: 10px;">
                  <span style="color: #60a5fa;">${idx + 1}.</span> 
                  <span style="color: #fbbf24;">${step.name}</span>
                  <div style="padding-left: 20px; color: #94a3b8;">
                    → ${step.db} queries → ${step.hooks} hooks → ${step.components} components
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    function showComponentDetails(componentName) {
      // This would show detailed component analysis
      console.log('Show component details for:', componentName);
      // TODO: Implement component detail view
    }

    // Unified function to show all validation results for any architectural element
    async function selectArchitectureItem(itemName, itemType, filePath = null) {
      try {
        // Update active state in sidebar
        document.querySelectorAll('.entity-item').forEach(el => {
          el.classList.remove('active');
          if (el.textContent.includes(itemName)) {
            el.classList.add('active');
          }
        });

        // Show main content panel
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = '<div style="padding: 20px;">Loading comprehensive analysis...</div>';

        // Fetch validation data for this specific file
        const [nineRulesRes, contractsRes] = await Promise.all([
          fetch('/api/nine-rules'),
          fetch('/api/contracts')
        ]);

        const [nineRulesData, contractsData] = await Promise.all([
          nineRulesRes.json(),
          contractsRes.json()
        ]);

        // Filter issues for this specific file
        const contractViolations = contractsData.violations?.filter(v => 
          v.location?.includes(filePath)
        ) || [];

        const codeQualityIssues = [];
        if (nineRulesData?.results) {
          nineRulesData.results.forEach(rule => {
            rule.issues?.forEach(issue => {
              if (issue.file === filePath) {
                codeQualityIssues.push({
                  rule: rule.rule,
                  ruleNumber: rule.ruleNumber,
                  ...issue
                });
              }
            });
          });
        }
        
        // Generate diagnostic HTML
        const diagnosticHtml = generateItemDiagnostic(itemName, itemType, contractViolations, codeQualityIssues);
        mainContent.innerHTML = diagnosticHtml;

      } catch (error) {
        console.error('Error loading architecture item details:', error);
        document.getElementById('mainContent').innerHTML = 
          '<div style="padding: 20px; color: #ef4444;">Error loading details. Please try again.</div>';
      }
    }

    function generateItemDiagnostic(itemName, itemType, contractViolations, codeQualityIssues) {
      const totalIssues = contractViolations.length + codeQualityIssues.length;
      const healthScore = totalIssues === 0 ? 100 : Math.max(10, 100 - (totalIssues * 15));
      const healthClass = healthScore >= 80 ? 'health-good' : healthScore >= 40 ? 'health-warning' : 'health-error';
      const critical = codeQualityIssues.filter(i => i.severity === 'critical').length;
      const warnings = codeQualityIssues.filter(i => i.severity === 'warning').length;

      return `
        <div style="padding: 20px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 30px;">
            <div style="font-size: 24px;">${getItemIcon(itemType)}</div>
            <div>
              <h2 style="margin: 0; color: #f8fafc;">${itemName}</h2>
              <p style="margin: 4px 0 0 0; color: #94a3b8; text-transform: capitalize;">${itemType}</p>
            </div>
            <div style="margin-left: auto; text-align: right;">
              <div style="color: #ef4444; font-size: 14px; margin-bottom: 4px;">
                ${contractViolations.length} contract errors, ${codeQualityIssues.length} quality issues
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: #94a3b8;">Health Score:</span>
                <span class="health-indicator ${healthClass}" style="margin-right: 8px;"></span>
                <span style="color: #f8fafc; font-weight: bold;">${healthScore}%</span>
              </div>
            </div>
          </div>

          ${totalIssues === 0 ? 
            '<div style="text-align: center; padding: 40px; color: #10b981; font-size: 18px;">✅ No issues found</div>' :
            `
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
              <div style="background: #1a1a1a; padding: 16px; border-radius: 8px; border-left: 4px solid ${codeQualityIssues.length > 0 ? (critical > 0 ? '#ef4444' : '#f59e0b') : '#10b981'};">
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Code Quality</div>
                <div style="color: #f8fafc; font-size: 20px; font-weight: bold;">${codeQualityIssues.length}</div>
                <div style="color: #94a3b8; font-size: 11px;">${critical} critical, ${warnings} warnings</div>
              </div>
              <div style="background: #1a1a1a; padding: 16px; border-radius: 8px; border-left: 4px solid ${contractViolations.length > 0 ? '#f59e0b' : '#10b981'};">
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Contracts</div>
                <div style="color: #f8fafc; font-size: 20px; font-weight: bold;">${contractViolations.length}</div>
                <div style="color: #94a3b8; font-size: 11px;">Type safety violations</div>
              </div>
            </div>

            ${renderCodeQualityIssues(codeQualityIssues)}
            ${renderContractViolations(contractViolations)}
            `
          }
        </div>
      `;
    }

    function renderCodeQualityIssues(issues) {
      if (issues.length === 0) return '';
      
      return `
        <div style="margin-bottom: 30px;">
          <h3 style="color: #f8fafc; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
            <span>🔍</span> Code Quality Issues
          </h3>
          ${issues.map(issue => `
            <div style="background: #1a1a1a; padding: 16px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid ${issue.severity === 'critical' ? '#ef4444' : '#f59e0b'};">
              <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 8px;">
                <div>
                  <span style="color: #64748b; font-size: 12px;">Rule ${issue.ruleNumber}:</span>
                  <span style="color: #f8fafc; font-weight: bold; margin-left: 8px;">${issue.rule}</span>
                </div>
                <span style="background: ${issue.severity === 'critical' ? '#ef4444' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase;">
                  ${issue.severity}
                </span>
              </div>
              <div style="color: #e2e8f0; margin-bottom: 8px; font-size: 14px;">${issue.message}</div>
              ${issue.line ? `<div style="color: #64748b; font-size: 12px; font-family: monospace; margin-bottom: 8px;">Line ${issue.line}</div>` : ''}
              ${issue.suggestion ? `<div style="color: #10b981; font-size: 13px; margin-top: 8px;">💡 ${issue.suggestion}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderContractViolations(violations) {
      if (violations.length === 0) return '';
      
      return `
        <div style="margin-bottom: 30px;">
          <h3 style="color: #f8fafc; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
            <span>📋</span> Contract Violations
          </h3>
          ${violations.map(violation => `
            <div style="background: #1a1a1a; padding: 16px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #f8fafc; font-weight: bold;">${violation.entity || 'Contract'}</span>
                <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">CONTRACT</span>
              </div>
              <div style="color: #e2e8f0; margin-bottom: 8px; font-size: 14px;">${violation.message}</div>
              ${violation.location ? `<div style="color: #64748b; font-size: 12px; font-family: monospace; margin-bottom: 8px;">${violation.location}</div>` : ''}
              ${violation.expected ? `<div style="background: #0a0a0a; padding: 8px; border-radius: 4px; margin-bottom: 4px;"><span style="color: #64748b; font-size: 11px;">Expected:</span> <span style="color: #10b981; font-family: monospace;">${violation.expected}</span></div>` : ''}
              ${violation.actual ? `<div style="background: #0a0a0a; padding: 8px; border-radius: 4px;"><span style="color: #64748b; font-size: 11px;">Actual:</span> <span style="color: #ef4444; font-family: monospace;">${violation.actual}</span></div>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function getItemIcon(itemType) {
      const icons = {
        hook: '🔗',
        component: '🧩', 
        api: '🌐',
        page: '📄',
        table: '📊'
      };
      return icons[itemType] || '📁';
    }


    
    // Helper function to escape HTML and preserve Unicode
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    
    // Helper to ensure proper text encoding
    function safeText(text) {
      if (!text) return '';
      return String(text);
    }
    
    function analyzeErrorHandling(query) {
      // Helper function to analyze error handling
      return {
        hasTryCatch: query.hasTryCatch || false,
        hasErrorState: query.hasErrorState || false,
        hasValidation: query.hasValidation || false
      };
    }
    
    function loadTableQueries(name, table) {
      const queryContent = document.getElementById('queryContent');
      
      // Get comprehensive query and flow data
      const queries = [];
      const errorChains = [];
      const dataFlows = [];
      
      // Analyze database queries with error tracking
      if (table.databaseQueries.length > 0) {
        table.databaseQueries.forEach(dbQuery => {
          queries.push({
            title: `${dbQuery.type || 'SELECT'} ${name}`,
            type: 'database',
            query: dbQuery.query || `SELECT * FROM ${name}s WHERE id = $1`,
            file: dbQuery.file,
            line: dbQuery.line,
            hasValidation: dbQuery.hasValidation || false,
            errorHandling: analyzeErrorHandling(dbQuery)
          });
        });
      }
      
      // Analyze hooks with full error chain
      table.hooks.forEach(hook => {
        const errorChain = {
          hook: hook.hookName,
          hasErrorState: hook.hasErrorHandling,
          hasLoadingState: hook.hasLoadingState,
          hasCacheInvalidation: hook.operations.includes('invalidate'),
          components: hook.usedInComponents || [],
          propagation: []
        };
        
        // Track error propagation
        if (!hook.hasErrorHandling) {
          errorChain.propagation.push({
            level: 'hook',
            issue: 'No error handling in hook',
            impact: 'Component will crash on error',
            fix: 'Add try-catch or error state'
          });
        }
        
        if (!hook.hasLoadingState) {
          errorChain.propagation.push({
            level: 'hook',
            issue: 'No loading state',
            impact: 'UI freezes during fetch',
            fix: 'Add isLoading state'
          });
        }
        
        errorChains.push(errorChain);
        
        // Add hook query
        queries.push({
          title: hook.hookName,
          type: 'hook',
          query: `const { data, error, isLoading } = ${hook.hookName}();\n\n// Used in: ${hook.usedInComponents?.join(', ') || 'Unknown'}`,
          file: hook.file,
          hasError: !hook.hasErrorHandling,
          hasLoading: hook.hasLoadingState,
          errorChain: errorChain
        });
      });
      
      // From mutations
      table.mutations.forEach(mutation => {
        queries.push({
          title: mutation.mutationName,
          type: 'mutation',
          query: `const { data, error } = await supabase\n  .from('${name}s')\n  .insert(values)`,
          file: mutation.file,
          hasCache: mutation.hasCacheInvalidation
        });
      });
      
      queryContent.innerHTML = queries.map(q => `
        <div class="query-box">
          <div class="query-title">${q.title}</div>
          <div class="query-code">${q.query}</div>
          
          ${q.type === 'select' ? `
            <div class="response-preview">
{
  "id": "123",
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z",
  ...
}</div>
          ` : ''}
          
          <div class="query-meta">
            <div class="meta-item">
              <span>📁</span>
              <span>${q.file?.split('/').pop() || 'unknown'}</span>
            </div>
            ${q.hasError === false ? `
              <div class="meta-item status-error">
                <span>❌</span>
                <span>No error handling</span>
              </div>
            ` : ''}
            ${q.hasLoading === true ? `
              <div class="meta-item status-success">
                <span>✅</span>
                <span>Loading state</span>
              </div>
            ` : ''}
            ${q.hasCache === false && q.type === 'mutation' ? `
              <div class="meta-item status-warning">
                <span>⚠️</span>
                <span>No cache invalidation</span>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('') || '<div style="color: #64748b; padding: 20px;">No queries found for this table</div>';
      
      // Enhanced view with error chains and data flow
      if (queries.length > 0 || errorChains.length > 0) {
        // Build HTML using DOM to avoid encoding issues
        const container = document.createElement('div');
        container.style.padding = '20px';
        
        const title = document.createElement('h3');
        title.style.marginBottom = '20px';
        title.style.color = '#e2e8f0';
        title.textContent = `Query Inspector - ${name}`;
        container.appendChild(title);
        
        // Data Flow section
        const flowSection = document.createElement('div');
        flowSection.style.background = '#1e293b';
        flowSection.style.padding = '15px';
        flowSection.style.borderRadius = '8px';
        flowSection.style.marginBottom = '20px';
        
        const flowTitle = document.createElement('h4');
        flowTitle.style.color = '#60a5fa';
        flowTitle.style.marginBottom = '10px';
        flowTitle.textContent = '📊 Data Flow Pipeline';
        flowSection.appendChild(flowTitle);
        
        // Pipeline container
        const pipeline = document.createElement('div');
        pipeline.style.display = 'flex';
        pipeline.style.alignItems = 'center';
        pipeline.style.gap = '10px';
        pipeline.style.padding = '10px';
        pipeline.style.background = 'rgba(0,0,0,0.3)';
        pipeline.style.borderRadius = '4px';
        pipeline.style.overflowX = 'auto';
        
        // Add pipeline stages
        const stages = [
          { name: 'Type', check: table.typeDefinition, color: table.typeDefinition ? '#1e40af' : '#7f1d1d' },
          { name: 'DB', check: table.databaseQueries.length > 0, color: table.databaseQueries.length > 0 ? '#7c3aed' : '#7f1d1d' },
          { name: 'Hooks', count: table.hooks.length, color: table.hooks.length > 0 ? '#0891b2' : '#7f1d1d', emoji: '🪝' },
          { name: 'UI', count: table.components.length, color: table.components.length > 0 ? '#059669' : '#7f1d1d', emoji: '🎨' }
        ];
        
        stages.forEach((stage, idx) => {
          const stageDiv = document.createElement('div');
          stageDiv.style.textAlign = 'center';
          stageDiv.style.minWidth = '80px';
          
          const stageLabel = document.createElement('div');
          stageLabel.style.padding = '8px';
          stageLabel.style.background = stage.color;
          stageLabel.style.borderRadius = '4px';
          stageLabel.textContent = stage.name;
          stageDiv.appendChild(stageLabel);
          
          const stageStatus = document.createElement('div');
          stageStatus.style.fontSize = '20px';
          stageStatus.style.marginTop = '5px';
          if (stage.count !== undefined) {
            stageStatus.textContent = stage.count + ' ' + (stage.emoji || '');
          } else {
            stageStatus.textContent = stage.check ? '✅' : '❌';
          }
          stageDiv.appendChild(stageStatus);
          
          pipeline.appendChild(stageDiv);
          
          if (idx < stages.length - 1) {
            const arrow = document.createElement('div');
            arrow.style.color = '#64748b';
            arrow.textContent = '→';
            pipeline.appendChild(arrow);
          }
        });
        
        flowSection.appendChild(pipeline);
        
        // Add error chain warnings if any
        const errorChainsWithIssues = errorChains.filter(c => c.propagation.length > 0);
        if (errorChainsWithIssues.length > 0) {
          const errorDiv = document.createElement('div');
          errorDiv.style.marginTop = '15px';
          errorDiv.style.background = 'rgba(239, 68, 68, 0.1)';
          errorDiv.style.padding = '10px';
          errorDiv.style.borderRadius = '4px';
          
          const errorTitle = document.createElement('div');
          errorTitle.style.color = '#fca5a5';
          errorTitle.style.fontWeight = 'bold';
          errorTitle.style.marginBottom = '8px';
          errorTitle.textContent = `⚠️ ${errorChainsWithIssues.length} Error Chains Detected`;
          errorDiv.appendChild(errorTitle);
          
          errorChainsWithIssues.slice(0, 3).forEach(chain => {
            const chainDiv = document.createElement('div');
            chainDiv.style.marginBottom = '5px';
            chainDiv.style.padding = '5px';
            chainDiv.style.background = 'rgba(0,0,0,0.2)';
            chainDiv.style.borderRadius = '4px';
            
            const hookSpan = document.createElement('span');
            hookSpan.style.color = '#fbbf24';
            hookSpan.textContent = chain.hook + ': ';
            chainDiv.appendChild(hookSpan);
            
            const issueSpan = document.createElement('span');
            issueSpan.style.color = '#ef4444';
            issueSpan.style.fontSize = '12px';
            issueSpan.textContent = chain.propagation[0].issue;
            chainDiv.appendChild(issueSpan);
            
            errorDiv.appendChild(chainDiv);
          });
          
          flowSection.appendChild(errorDiv);
        }
        
        container.appendChild(flowSection);
        
        // Add query list section
        const queryListDiv = document.createElement('div');
        queryListDiv.style.maxHeight = '400px';
        queryListDiv.style.overflowY = 'auto';
        queryListDiv.innerHTML = queryContent.innerHTML;
        container.appendChild(queryListDiv);
        
        // Set the enhanced content
        queryContent.innerHTML = '';
        queryContent.appendChild(container);
      }
    }

    async function loadOverview(showDataFlow = false) {
      const mainContent = document.getElementById('mainContent');
      const sidebar = document.getElementById('sidebar');
      
      // Hide query panel when loading overview (only show when table selected)
      const queryPanel = document.querySelector('.query-panel');
      if (queryPanel && !currentTable) {
        queryPanel.style.display = 'none';
      }
      
      // Update sidebar to show tables/hooks/components
      if (sidebar) {
        sidebar.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">📦 Project Structure</h3>
            <button onclick="loadOverview(false)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: ${!showDataFlow ? '#3b82f6' : '#1a1a1a'}; border: none; border-radius: 6px; color: white; cursor: pointer;">
              📊 Overview
            </button>
            <button onclick="loadOverview(true)" style="width: 100%; padding: 10px; background: ${showDataFlow ? '#3b82f6' : '#1a1a1a'}; border: none; border-radius: 6px; color: white; cursor: pointer;">
              🔄 Data Flow
            </button>
          </div>
        `;
      }
      
      if (showDataFlow) {
        loadDataFlow();
        return;
      }
      
      // Fetch unified report for CORRECT severity data
      try {
        const response = await fetch('/api/unified-report');
        const report = await response.json();
        
        const hasBreaking = report.summary.criticalCount > 0;
        const score = Math.max(0, 100 - (report.summary.criticalCount * 30) - (report.summary.warningCount * 10));
        const scoreColor = score >= 90 ? '#10b981' : score >= 70 ? '#f59e0b' : '#ef4444';
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <!-- Main Status with CORRECT severity -->
            <div style="
              background: ${hasBreaking ? 'linear-gradient(135deg, #7f1d1d, #991b1b)' : '#1a1a1a'};
              padding: 30px;
              border-radius: 12px;
              margin-bottom: 24px;
              border: 2px solid ${hasBreaking ? '#ef4444' : '#333'};
            ">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h1 style="color: #f8fafc; margin: 0; font-size: 32px;">
                    ${hasBreaking ? '🚨 Critical Issues Found!' : '✅ No Critical Issues'}
                  </h1>
                  <p style="color: ${hasBreaking ? '#fca5a5' : '#94a3b8'}; margin-top: 10px; font-size: 16px;">
                    ${report.summary.topPriority}
                  </p>
                </div>
                
                ${renderHealthScore(score)}
              </div>
            </div>
            
            <!-- Issue Counts with CORRECT labels - using shared function -->
            ${renderSeverityCounts(report.summary.criticalCount, report.summary.warningCount, report.summary.infoCount)}
            
            <!-- Tables Summary -->
            <div class="section">
              <div class="section-title">📊 Database Tables</div>
              <div class="usage-grid">
                <div class="usage-stat">
                  <div class="usage-number">${Object.keys(tableMapping.tables || {}).length}</div>
                  <div class="usage-label">Total Tables</div>
                </div>
                <div class="usage-stat">
                  <div class="usage-number">${tableMapping.summary?.fullyMapped || 0}</div>
                  <div class="usage-label">Fully Mapped</div>
                </div>
                <div class="usage-stat">
                  <div class="usage-number">${tableMapping.summary?.partiallyMapped || 0}</div>
                  <div class="usage-label">Partial</div>
                </div>
                <div class="usage-stat">
                  <div class="usage-number">${tableMapping.summary?.unmapped || 0}</div>
                  <div class="usage-label">Unmapped</div>
                </div>
              </div>
            </div>
            
            <!-- Top Critical Issues -->
            ${report.criticalIssues && report.criticalIssues.length > 0 ? `
              <div class="section">
                <div class="section-title">🚨 Top Critical Issues</div>
                ${report.criticalIssues.slice(0, 5).map(issue => `
                  <div class="relationship-item">
                    <span style="color: #ef4444;">❌</span>
                    <span>${issue.message || issue.issue}</span>
                    <span style="color: #64748b; font-size: 11px; margin-left: 8px;">
                      ${issue.file || issue.location || ''}
                    </span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      } catch (error) {
        console.error('Failed to load unified report:', error);
        // Fallback to old overview
        mainContent.innerHTML = `
          <h2 style="margin-bottom: 20px;">Project Overview</h2>
          <div style="color: #ef4444; padding: 20px;">
            Failed to load overview data: ${error.message}
          </div>
        `;
      }
      
      // Clear query panel
      document.getElementById('queryContent').innerHTML = `
        <div style="color: #64748b; padding: 20px; text-align: center;">
          Select a table to inspect its queries
        </div>
      `;
    }

    async function loadDataFlow() {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      // Clear query panel
      if (queryContent) queryContent.innerHTML = '';
      
      mainContent.innerHTML = '<div style="padding: 20px;">Loading data flow analysis...</div>';
      
      try {
        const res = await fetch('/api/data-flow-view');
        const html = await res.text();
        mainContent.innerHTML = html;
        console.log('Data flow loaded successfully');
      } catch (error) {
        console.error('Error loading data flow:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading data flow: ' + error.message + '</div>';
      }
    }
    
    async function runDataFlowAnalysis() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div style="padding: 20px;">🔄 Running data flow analysis...</div>';
      
      try {
        // Run the analysis
        const res = await fetch('/api/data-flow');
        const data = await res.json();
        
        // Reload the view with new data
        await loadDataFlow();
      } catch (error) {
        console.error('Error running analysis:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error running analysis: ' + error.message + '</div>';
      }
    }
    
    // Global functions for Data Flow tabs
    window.switchDataFlowTab = function(tabName, button) {
      // Hide all tab contents
      document.querySelectorAll('.dftab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Show selected tab content
      const selectedContent = document.getElementById('dftab-' + tabName);
      if (selectedContent) {
        selectedContent.style.display = 'block';
      }
      
      // Update button styles
      document.querySelectorAll('.dftab').forEach(tab => {
        tab.style.background = 'transparent';
        tab.style.color = '#94a3b8';
        tab.classList.remove('dftab-active');
      });
      
      if (button) {
        button.style.background = '#2563eb';
        button.style.color = 'white';
        button.classList.add('dftab-active');
      }
    }
    
    window.exportFlowData = function() {
      if (window.dataFlowData) {
        const dataStr = JSON.stringify(window.dataFlowData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', 'data-flow-analysis.json');
        link.click();
      }
    }
    
    window.filterDataNodes = function(searchTerm) {
      const cards = document.querySelectorAll('.df-node-card');
      cards.forEach(card => {
        const name = card.getAttribute('data-node-name');
        if (name && name.includes(searchTerm.toLowerCase())) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    window.testDataFlow = function() {
      const results = document.getElementById('df-test-results');
      const trace = document.getElementById('df-flow-trace');
      
      if (results) {
        results.innerHTML = `
          <div style="color: #10b981; margin-bottom: 10px;">✅ Flow validation passed</div>
          <div style="background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <div style="color: #64748b; font-size: 11px; margin-bottom: 5px;">Type Validation</div>
            <div style="color: #10b981;">✓ All types match expected schema</div>
          </div>
        `;
      }
      
      if (trace) {
        trace.innerHTML = `
          <div style="font-family: monospace; font-size: 12px;">
            <div style="color: #3b82f6; margin-bottom: 5px;">1. Type: User validated ✓</div>
            <div style="color: #8b5cf6; margin-bottom: 5px;">2. Table: users accessed ✓</div>
            <div style="color: #06b6d4; margin-bottom: 5px;">3. Hook: useAuth called ✓</div>
            <div style="color: #10b981; margin-bottom: 5px;">4. Component: LoginForm rendered ✓</div>
            <div style="color: #f59e0b;">5. API: /api/auth/login called ✓</div>
          </div>
        `;
      }
    }

    async function loadQueries() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <h2 style="margin-bottom: 20px;">Query Inspector</h2>
        <div style="color: #64748b; padding: 20px;">
          Select a table from the sidebar to inspect its queries in Postman-style format
        </div>
      `;
    }

    async function loadValidation() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div style="padding: 20px;">Running validation checks...</div>';
      
      try {
        // First run validation
        await fetch('/api/validate');
        
        // Then get the validation view
        const res = await fetch('/api/validation-view');
        const html = await res.text();
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 30px;">🔍 80-20 Validation Results</h2>
            ${html}
          </div>
        `;
      } catch (error) {
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading validation</div>';
      }
    }

    async function loadRegistry() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div style="padding: 20px;">Checking registry usage...</div>';
      
      try {
        // Make sure validation has run
        await fetch('/api/validate');
        
        // Get registry view
        const res = await fetch('/api/registry-view');
        const html = await res.text();
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            ${html}
          </div>
        `;
      } catch (error) {
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading registry validation</div>';
      }
    }

    async function loadContracts(groupBy = 'table', runValidation = true, view = 'contracts') {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      const sidebar = document.getElementById('sidebar');
      
      if (queryContent) queryContent.innerHTML = '';
      
      // Update sidebar with contract sub-views
      if (sidebar) {
        sidebar.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">📋 Contract Views</h3>
            <button onclick="loadContracts('table', false, 'contracts')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: ${view === 'contracts' ? '#3b82f6' : '#1a1a1a'}; border: none; border-radius: 6px; color: white; cursor: pointer;">
              📋 Contracts
            </button>
            <button onclick="loadContracts('table', false, 'boundaries')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: ${view === 'boundaries' ? '#3b82f6' : '#1a1a1a'}; border: none; border-radius: 6px; color: white; cursor: pointer;">
              🎯 Boundaries
            </button>
            <button onclick="loadContracts('table', false, 'versions')" style="width: 100%; padding: 10px; background: ${view === 'versions' ? '#3b82f6' : '#1a1a1a'}; border: none; border-radius: 6px; color: white; cursor: pointer;">
              🔄 Versions
            </button>
          </div>
        `;
      }
      
      // Save scroll position before updating
      const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
      
      // Make loadContracts available globally for the component
      window.loadContractValidation = loadContracts;
      
      if (!runValidation) {
        // Don't show loading message for quick updates
      } else {
        mainContent.innerHTML = '<div style="padding: 20px;">Running contract validation...</div>';
      }
      
      try {
        if (view === 'boundaries') {
          await loadBoundaries();
          return;
        } else if (view === 'versions') {
          await loadVersions();
          return;
        }
        
        // Default contracts view
        // Fetch the pre-rendered HTML from our component
        const res = await fetch(`/api/contracts-html?groupBy=${groupBy}`);
        const html = await res.text();
        
        mainContent.innerHTML = html;
        
        // Restore scroll position after content loads
        if (!runValidation) {
          requestAnimationFrame(() => {
            window.scrollTo({
              top: scrollPos,
              behavior: 'instant'
            });
          });
        }
      } catch (error) {
        console.error('Error loading contracts:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading contract validation</div>';
      }
    }
    
    async function loadCodeQuality(groupBy = 'rule', runValidation = true) {
      // This consolidates: 9 Rules, Health Check, Registry (which is Rule #6)
      const mainContent = document.getElementById('mainContent');
      const queryPanel = document.getElementById('queryContent');
      
      // Hide query panel for this view
      if (queryPanel) queryPanel.style.display = 'none';
      
      // Save scroll position before updating
      const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
      
      // Make function available globally for the component
      window.loadCodeQuality = loadCodeQuality;
      
      try {
        // Only run validation on first load
        if (runValidation) {
          mainContent.innerHTML = '<div style="padding: 20px;">Running code quality analysis...</div>';
          await fetch('/api/nine-rules'); // This includes all rules including registry
        } else {
          // Don't show loading message for quick updates
        }
        
        // Get the enhanced rendered view with grouping
        const res = await fetch(`/api/nine-rules-enhanced?groupBy=${groupBy}`);
        const html = await res.text();
        
        // Update the title in the HTML to reflect consolidated view
        const updatedHtml = html.replace('9 Core Rules Validation', 'Code Quality Analysis');
        
        mainContent.innerHTML = updatedHtml;
        
        // Restore scroll position after content loads
        if (!runValidation) {
          requestAnimationFrame(() => {
            window.scrollTo({
              top: scrollPos,
              behavior: 'instant'
            });
          });
        }
      } catch (error) {
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading code quality analysis</div>';
      }
    }
    
    async function loadNineRules(groupBy = 'rule', runValidation = true) {
      const mainContent = document.getElementById('mainContent');
      
      // Save scroll position before updating
      const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
      
      // Make loadNineRules available globally for the component
      window.loadNineRules = loadNineRules;
      
      try {
        // Only run validation on first load
        if (runValidation) {
          mainContent.innerHTML = '<div style="padding: 20px;">Running 9 Core Rules validation...</div>';
          await fetch('/api/nine-rules');
        } else {
          // Don't show loading message for quick updates
        }
        
        // Get the enhanced rendered view with grouping
        const res = await fetch(`/api/nine-rules-enhanced?groupBy=${groupBy}`);
        const html = await res.text();
        
        mainContent.innerHTML = html;
        
        // Restore scroll position after content loads
        if (!runValidation) {
          requestAnimationFrame(() => {
            window.scrollTo({
              top: scrollPos,
              behavior: 'instant'
            });
          });
        }
      } catch (error) {
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading 9-rules view</div>';
      }
    }
    
    async function loadBusiness() {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      if (queryContent) queryContent.innerHTML = '';
      
      mainContent.innerHTML = '<div style="padding: 20px;">Loading business logic...</div>';
      
      try {
        const res = await fetch('/api/business-logic');
        const data = await res.json();
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 30px;">📝 Business Logic Rules</h2>
            
            <!-- Two Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
              <!-- Business Rules Column -->
              <div>
                <h3 style="color: #60a5fa; margin-bottom: 20px;">Plain English Rules</h3>
                <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto;">
                  ${data.rules.map(section => `
                    <div style="margin-bottom: 25px;">
                      <h4 style="color: #fbbf24; margin-bottom: 10px; font-size: 16px;">
                        ${section.entity}
                      </h4>
                      <ul style="color: #94a3b8; line-height: 1.8; list-style: none; padding: 0;">
                        ${section.rules.map(rule => `
                          <li style="margin-bottom: 8px; padding-left: 20px; position: relative;">
                            <span style="position: absolute; left: 0; color: #10b981;">✓</span>
                            ${rule}
                          </li>
                        `).join('')}
                      </ul>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- Contract Status Column -->
              <div>
                <h3 style="color: #10b981; margin-bottom: 20px;">Contract Coverage</h3>
                <div style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
                  <!-- Coverage Stats -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 6px; text-align: center;">
                      <div style="font-size: 24px; font-weight: bold; color: #60a5fa;">
                        ${data.stats.totalRules || 0}
                      </div>
                      <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                        Total Business Rules
                      </div>
                    </div>
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 6px; text-align: center;">
                      <div style="font-size: 24px; font-weight: bold; color: ${data.stats.coverage >= 80 ? '#10b981' : '#f59e0b'};">
                        ${data.stats.coverage || 0}%
                      </div>
                      <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                        Rules with Contracts
                      </div>
                    </div>
                  </div>
                  
                  <!-- Mapping Preview -->
                  <div style="background: #0f0f0f; padding: 15px; border-radius: 6px;">
                    <h4 style="color: #94a3b8; margin-bottom: 10px; font-size: 14px;">
                      Business → Technical Mapping
                    </h4>
                    ${data.mappings ? data.mappings.slice(0, 5).map(map => `
                      <div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px;">
                        <div style="color: #fbbf24; font-size: 12px; margin-bottom: 5px;">
                          "${map.businessRule}"
                        </div>
                        <div style="color: #60a5fa; font-size: 11px; font-family: monospace;">
                          → ${map.contract}
                        </div>
                      </div>
                    `).join('') : '<div style="color: #64748b;">No mappings defined yet</div>'}
                  </div>
                  
                  <!-- Action Buttons -->
                  <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="generateContracts()" style="flex: 1; background: #2563eb; color: white; padding: 10px; border-radius: 6px; border: none; cursor: pointer;">
                      Generate Contracts
                    </button>
                    <button onclick="validateAlignment()" style="flex: 1; background: #059669; color: white; padding: 10px; border-radius: 6px; border: none; cursor: pointer;">
                      Check Alignment
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Instructions -->
            <div style="background: #1e293b; padding: 20px; border-radius: 8px; margin-top: 30px;">
              <h3 style="color: #60a5fa; margin-bottom: 15px;">How to Use Business Logic</h3>
              <ol style="color: #94a3b8; line-height: 1.8;">
                <li>Edit <code style="background: #0f0f0f; padding: 2px 6px; border-radius: 4px;">contracts/business.md</code> to define rules in plain English</li>
                <li>The system will detect which rules have technical contracts</li>
                <li>Click "Generate Contracts" to create YAML contracts from business rules</li>
                <li>Use these rules as context when generating code with AI</li>
              </ol>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading business logic:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading business logic</div>';
      }
    }
    
    function generateContracts() {
      alert('Contract generation from business rules coming soon!');
    }
    
    function validateAlignment() {
      alert('Business-Technical alignment check coming soon!');
    }
    
    async function loadBoundaries() {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      if (queryContent) queryContent.innerHTML = '';
      
      mainContent.innerHTML = '<div style="padding: 20px;">Analyzing boundary validations...</div>';
      
      try {
        const res = await fetch('/api/boundaries');
        const data = await res.json();
        
        const coverageColor = data.coverage >= 80 ? '#10b981' : data.coverage >= 50 ? '#f59e0b' : '#ef4444';
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 30px;">🛡️ Boundary Validation</h2>
            
            <!-- Coverage Card -->
            <div style="background: linear-gradient(135deg, ${data.coverage >= 80 ? '#047857' : data.coverage >= 50 ? '#b45309' : '#b91c1c'} 0%, ${data.coverage >= 80 ? '#065f46' : data.coverage >= 50 ? '#92400e' : '#991b1b'} 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="font-size: 20px; margin-bottom: 10px;">Boundary Coverage</h3>
                  <div style="display: flex; align-items: baseline; gap: 15px;">
                    <span style="font-size: 48px; font-weight: bold;">${data.coverage}%</span>
                    <span style="font-size: 18px; opacity: 0.8;">
                      ${data.boundaries.length} boundaries found
                    </span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 32px; font-weight: bold;">${data.critical?.length || 0}</div>
                  <div style="opacity: 0.8;">Critical Issues</div>
                </div>
              </div>
            </div>
            
            <!-- Critical Boundaries -->
            ${data.critical && data.critical.length > 0 ? `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #ef4444; margin-bottom: 20px;">🔴 Critical Unvalidated Boundaries</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                  ${data.critical.map(b => `
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                      <div style="color: #f87171; font-weight: 500;">
                        ${b.boundary.toUpperCase()} Boundary
                      </div>
                      <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                        📍 ${b.location}
                      </div>
                      <div style="color: #fbbf24; font-size: 12px; margin-top: 5px;">
                        ⚠️ ${b.issue}
                      </div>
                      <div style="background: #1e293b; padding: 8px; border-radius: 4px; margin-top: 8px;">
                        <code style="color: #60a5fa; font-size: 11px;">Add: Schema.parse(data)</code>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            <!-- Boundary Types -->
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
              <h3 style="color: #60a5fa; margin-bottom: 20px;">Boundary Types Coverage</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.entries(data.byType || {}).map(([type, info]) => `
                  <div style="background: #0f0f0f; padding: 15px; border-radius: 6px;">
                    <div style="color: #94a3b8; font-size: 12px; margin-bottom: 5px;">
                      ${type}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 24px; font-weight: bold; color: ${info.coverage >= 80 ? '#10b981' : info.coverage >= 50 ? '#f59e0b' : '#ef4444'};">
                        ${info.coverage}%
                      </span>
                      <span style="color: #64748b; font-size: 11px;">
                        ${info.validated}/${info.total}
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading boundaries:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading boundary validation</div>';
      }
    }
    
    async function loadDesignSystem() {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      if (queryContent) queryContent.innerHTML = '';
      
      mainContent.innerHTML = '<div style="padding: 20px;">Analyzing design system usage...</div>';
      
      try {
        const res = await fetch('/api/design-system');
        const data = await res.json();
        
        const scoreColor = data.score >= 80 ? '#10b981' : data.score >= 50 ? '#f59e0b' : '#ef4444';
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 30px;">🎨 Design System Validation</h2>
            
            <!-- Score Card -->
            <div style="background: linear-gradient(135deg, ${data.score >= 80 ? '#047857' : data.score >= 50 ? '#b45309' : '#b91c1c'} 0%, ${data.score >= 80 ? '#065f46' : data.score >= 50 ? '#92400e' : '#991b1b'} 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="font-size: 20px; margin-bottom: 10px;">Design System Score</h3>
                  <div style="display: flex; align-items: baseline; gap: 15px;">
                    <span style="font-size: 48px; font-weight: bold;">${data.score}/100</span>
                    <span style="font-size: 18px; opacity: 0.8;">
                      ${data.score >= 80 ? 'Excellent' : data.score >= 50 ? 'Good' : 'Needs Work'}
                    </span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Design System Location:</div>
                  <div style="font-size: 16px; font-weight: 500;">
                    ${data.designSystemPath || 'Auto-detected'}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Violation Summary -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: ${data.summary.imports > 0 ? '#f59e0b' : '#10b981'};">
                  ${data.summary.imports}
                </div>
                <div style="color: #94a3b8; margin-top: 5px;">Import Violations</div>
                <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                  Raw HTML or banned imports
                </div>
              </div>
              
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: ${data.summary.tokens > 0 ? '#f59e0b' : '#10b981'};">
                  ${data.summary.tokens}
                </div>
                <div style="color: #94a3b8; margin-top: 5px;">Token Violations</div>
                <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                  Hardcoded colors or values
                </div>
              </div>
              
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: ${data.summary.a11y > 0 ? '#ef4444' : '#10b981'};">
                  ${data.summary.a11y}
                </div>
                <div style="color: #94a3b8; margin-top: 5px;">A11y Violations</div>
                <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                  Missing alt, labels, ARIA
                </div>
              </div>
              
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: ${data.summary.total > 0 ? '#ef4444' : '#10b981'};">
                  ${data.summary.total}
                </div>
                <div style="color: #94a3b8; margin-top: 5px;">Total Violations</div>
                <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                  All design system issues
                </div>
              </div>
            </div>
            
            <!-- Violations List -->
            ${data.violations && data.violations.length > 0 ? `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #f59e0b; margin-bottom: 20px;">Design System Violations</h3>
                <div style="max-height: 500px; overflow-y: auto;">
                  ${data.violations.slice(0, 20).map(v => `
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid ${v.severity === 'error' ? '#ef4444' : '#f59e0b'};">
                      <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                          <div style="color: ${v.severity === 'error' ? '#f87171' : '#fbbf24'}; font-weight: 500;">
                            ${v.message}
                          </div>
                          <div style="color: #64748b; font-size: 12px; margin-top: 5px;">
                            📍 ${v.file.split('/').slice(-2).join('/')}:${v.line}
                          </div>
                          <div style="color: #60a5fa; font-size: 12px; margin-top: 5px;">
                            💡 ${v.suggestion}
                          </div>
                        </div>
                        <span style="background: ${v.type === 'a11y' ? '#7c2d12' : v.type === 'import' ? '#78350f' : '#1e3a8a'}; padding: 4px 8px; border-radius: 4px;">
                          <span style="color: white; font-size: 11px; text-transform: uppercase;">
                            ${v.type}
                          </span>
                        </span>
                      </div>
                    </div>
                  `).join('')}
                  ${data.violations.length > 20 ? `
                    <div style="text-align: center; color: #64748b; padding: 10px;">
                      ... and ${data.violations.length - 20} more violations
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : `
              <div style="background: #1a1a1a; padding: 40px; border-radius: 8px; text-align: center;">
                <div style="color: #10b981; font-size: 24px; margin-bottom: 10px;">✅</div>
                <div style="color: #10b981; font-size: 18px;">Perfect! No design system violations found.</div>
              </div>
            `}
            
            <!-- Best Practices -->
            <div style="background: #1e293b; padding: 20px; border-radius: 8px; margin-top: 20px;">
              <h3 style="color: #60a5fa; margin-bottom: 15px;">Design System Best Practices</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                  <h4 style="color: #94a3b8; margin-bottom: 10px;">✅ DO</h4>
                  <ul style="color: #64748b; line-height: 1.8; list-style: none;">
                    <li>• Import from ${data.designSystemPath || '@/components/ui'}</li>
                    <li>• Use design tokens (colors, spacing)</li>
                    <li>• Add alt text to images</li>
                    <li>• Label all form inputs</li>
                    <li>• Use semantic HTML</li>
                  </ul>
                </div>
                <div>
                  <h4 style="color: #94a3b8; margin-bottom: 10px;">❌ DON'T</h4>
                  <ul style="color: #64748b; line-height: 1.8; list-style: none;">
                    <li>• Use raw HTML (button, input)</li>
                    <li>• Hardcode colors (#7C3AED)</li>
                    <li>• Use arbitrary values (text-[17px])</li>
                    <li>• Import from UI libraries directly</li>
                    <li>• Skip accessibility attributes</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading design system validation:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading design system validation</div>';
      }
    }
    
    async function loadVersions() {
      const mainContent = document.getElementById('mainContent');
      const queryContent = document.getElementById('queryContent');
      
      if (queryContent) queryContent.innerHTML = '';
      
      mainContent.innerHTML = '<div style="padding: 20px;">Checking version control...</div>';
      
      try {
        const res = await fetch('/api/versions');
        const data = await res.json();
        
        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 30px;">📦 Version Control</h2>
            
            <!-- Version Coverage -->
            <div style="background: linear-gradient(135deg, ${data.coverage >= 80 ? '#047857' : '#b45309'} 0%, ${data.coverage >= 80 ? '#065f46' : '#92400e'} 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
              <h3 style="font-size: 20px; margin-bottom: 10px;">Version Coverage</h3>
              <div style="display: flex; align-items: baseline; gap: 15px;">
                <span style="font-size: 48px; font-weight: bold;">${data.coverage}%</span>
                <span style="font-size: 18px; opacity: 0.8;">
                  schemas properly versioned
                </span>
              </div>
            </div>
            
            <!-- Version Violations -->
            ${data.violations && data.violations.length > 0 ? `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #ef4444; margin-bottom: 20px;">Version Issues</h3>
                ${data.violations.map(v => `
                  <div style="background: #0f0f0f; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid ${v.severity === 'error' ? '#ef4444' : '#f59e0b'};">
                    <div style="display: flex; justify-content: space-between;">
                      <div>
                        <div style="color: ${v.severity === 'error' ? '#f87171' : '#fbbf24'}; font-weight: 500;">
                          ${v.schema}: ${v.issue}
                        </div>
                        <div style="color: #60a5fa; font-size: 12px; margin-top: 5px;">
                          💡 ${v.suggestion}
                        </div>
                      </div>
                      <span style="background: ${v.severity === 'error' ? '#7c2d12' : '#78350f'}; padding: 4px 8px; border-radius: 4px; height: fit-content;">
                        <span style="color: ${v.severity === 'error' ? '#fca5a5' : '#fcd34d'}; font-size: 11px; text-transform: uppercase;">
                          ${v.severity}
                        </span>
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <!-- Schema Versions Table -->
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
              <h3 style="color: #60a5fa; margin-bottom: 20px;">Schema Versions</h3>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid #333;">
                      <th style="text-align: left; padding: 10px; color: #94a3b8;">Schema</th>
                      <th style="text-align: left; padding: 10px; color: #94a3b8;">Version</th>
                      <th style="text-align: left; padding: 10px; color: #94a3b8;">Status</th>
                      <th style="text-align: left; padding: 10px; color: #94a3b8;">File</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(data.schemas || []).map(s => `
                      <tr style="border-bottom: 1px solid #252525;">
                        <td style="padding: 10px; color: #e2e8f0;">${s.name}</td>
                        <td style="padding: 10px;">
                          <span style="background: #2563eb; padding: 2px 8px; border-radius: 4px; color: white; font-size: 12px;">
                            ${s.version}
                          </span>
                        </td>
                        <td style="padding: 10px;">
                          ${s.deprecationDate ? 
                            `<span style="color: #f59e0b;">Deprecated ${s.deprecationDate}</span>` : 
                            '<span style="color: #10b981;">Active</span>'
                          }
                        </td>
                        <td style="padding: 10px; color: #64748b; font-size: 12px;">
                          ${s.filePath.split('/').pop()}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Migration Guide -->
            <div style="background: #1e293b; padding: 20px; border-radius: 8px; margin-top: 20px;">
              <h3 style="color: #60a5fa; margin-bottom: 15px;">Version Migration Guide</h3>
              <ol style="color: #94a3b8; line-height: 1.8;">
                <li>Never edit existing versions - create new version for breaking changes</li>
                <li>Always provide migration adapters (e.g., <code>toProfessionalV2()</code>)</li>
                <li>Document changes in CONTRACTS_CHANGELOG.md</li>
                <li>Set deprecation dates (minimum 30 days)</li>
                <li>Test with fixtures for each version</li>
              </ol>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading versions:', error);
        mainContent.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error loading version control</div>';
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Show/hide entire query panel based on tab
      const queryPanel = document.querySelector('.query-panel');
      if (queryPanel) {
        // Only show query panel in overview when viewing table details
        queryPanel.style.display = (tab === 'overview' && currentTable) ? 'block' : 'none';
      }
      
      // Load appropriate content
      switch(tab) {
        case 'overview':
          loadOverview();
          break;
        case 'unified':
          loadUnifiedView();
          break;
        case 'code-quality':
          loadCodeQuality();
          break;
        case 'contracts':
          loadContracts();
          break;
        case 'business':
          loadBusiness();
          break;
        case 'design':
          loadDesignSystem();
          break;
        case 'contract-tests':
          loadContractTests();
          break;
        case 'export':
          loadExportView();
          break;
      }
    }

    // Quick Action Functions
    async function runAllValidations() {
      const statusEl = document.getElementById('lastRunStatus');
      if (statusEl) statusEl.textContent = 'Running...';
      
      // Show log panel
      showLogPanel('Starting all validations...');
      
      try {
        // Run health score calculation
        addLog('✅ Running health score analysis...');
        const healthRes = await fetch('/api/health-score');
        if (healthRes.ok) {
          const healthData = await healthRes.json();
          addLog(`   Score: ${healthData.score}%, Errors: ${healthData.errors}, Warnings: ${healthData.warnings}`);
        }
        
        // Run validation report
        addLog('✅ Running validation report...');
        const validationRes = await fetch('/api/validation-report');
        if (validationRes.ok) {
          const validationData = await validationRes.json();
          addLog(`   Tables: ${validationData.tablesAnalyzed || 0}, Issues: ${validationData.totalIssues || 0}`);
        }
        
        // Save baseline
        addLog('✅ Saving baseline snapshot...');
        const baselineRes = await fetch('/api/save-baseline', { method: 'POST' });
        if (baselineRes.ok) {
          addLog('   Baseline saved successfully');
        }
        
        // Analyze risk areas
        addLog('✅ Analyzing risk areas...');
        const riskRes = await fetch('/api/risk-areas');
        if (riskRes.ok) {
          const riskData = await riskRes.json();
          addLog(`   Found ${riskData.length} risk areas`);
        }
        
        addLog('✅ All validations complete!', 'success');
        
        // Reload current tab with fresh data
        const currentTabElement = document.querySelector('.tab.active');
        if (currentTabElement) {
          currentTabElement.click();
        }
        
        if (statusEl) statusEl.textContent = `Last run: ${new Date().toLocaleTimeString()}`;
      } catch (error) {
        addLog(`❌ Error: ${error.message}`, 'error');
        if (statusEl) statusEl.textContent = 'Validation failed';
      }
    }
    
    function showLogPanel(message) {
      const mainContent = document.getElementById('mainContent');
      const existingLog = document.getElementById('validation-log');
      
      if (!existingLog) {
        // Create floating log panel in corner
        const logPanel = document.createElement('div');
        logPanel.id = 'validation-log';
        logPanel.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 400px;
          max-height: 300px;
          background: rgba(20, 20, 30, 0.95);
          border: 1px solid #333;
          border-radius: 8px;
          padding: 15px;
          z-index: 1000;
          overflow-y: auto;
        `;
        logPanel.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong style="color: #60a5fa;">Validation Log</strong>
            <button onclick="document.getElementById('validation-log').remove()" style="background: none; border: none; color: #64748b; cursor: pointer;">✕</button>
          </div>
          <div id="log-messages" style="font-family: monospace; font-size: 12px;"></div>
        `;
        document.body.appendChild(logPanel);
      }
      
      addLog(message);
    }
    
    function addLog(message, type = 'info') {
      const logMessages = document.getElementById('log-messages');
      if (logMessages) {
        const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#64748b';
        const logEntry = document.createElement('div');
        logEntry.style.cssText = `color: ${color}; margin-bottom: 5px;`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logMessages.appendChild(logEntry);
        logMessages.scrollTop = logMessages.scrollHeight;
      }
    }
    
    async function exportReport() {
      // Show export options dialog
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 24px;
        z-index: 10000;
        min-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      `;
      
      dialog.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #e2e8f0;">📤 Export Options</h3>
        
        <!-- Quick Presets -->
        <div style="margin-bottom: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">Quick Presets:</div>
          <div style="display: flex; gap: 8px;">
            <button onclick="selectExportPreset('ai-fix')" style="padding: 6px 12px; background: #1e40af; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
              🤖 For AI Fixing
            </button>
            <button onclick="selectExportPreset('review')" style="padding: 6px 12px; background: #7c3aed; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
              📝 Code Review
            </button>
            <button onclick="selectExportPreset('report')" style="padding: 6px 12px; background: #059669; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
              📊 Full Report
            </button>
          </div>
        </div>
        
        <!-- Granular Selection -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">Select specific sections:</div>
          
          <!-- Code Quality -->
          <details style="margin-bottom: 8px;">
            <summary style="cursor: pointer; padding: 8px; background: #0f0f0f; border-radius: 4px;">
              ✅ Code Quality
            </summary>
            <div style="padding: 8px 0 0 16px;">
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-9rules" style="margin-right: 6px;">
                <span>9 Core Rules Issues</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-registry" style="margin-right: 6px;">
                <span>Registry Usage (Rule 6)</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-critical" style="margin-right: 6px;">
                <span>Critical Issues Only</span>
              </label>
            </div>
          </details>
          
          <!-- Contracts -->
          <details style="margin-bottom: 8px;">
            <summary style="cursor: pointer; padding: 8px; background: #0f0f0f; border-radius: 4px;">
              📋 Contracts
            </summary>
            <div style="padding: 8px 0 0 16px;">
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-contract-violations" style="margin-right: 6px;">
                <span>Contract Violations</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-missing-contracts" style="margin-right: 6px;">
                <span>Missing Contracts</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-contract-suggestions" style="margin-right: 6px;">
                <span>Contract Suggestions</span>
              </label>
            </div>
          </details>
          
          <!-- Business Logic -->
          <details style="margin-bottom: 8px;">
            <summary style="cursor: pointer; padding: 8px; background: #0f0f0f; border-radius: 4px;">
              🏢 Business Logic
            </summary>
            <div style="padding: 8px 0 0 16px;">
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-business-rules" style="margin-right: 6px;">
                <span>Business Rules</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-rule-violations" style="margin-right: 6px;">
                <span>Rule Violations</span>
              </label>
            </div>
          </details>
          
          <!-- Design System -->
          <details style="margin-bottom: 8px;">
            <summary style="cursor: pointer; padding: 8px; background: #0f0f0f; border-radius: 4px;">
              🎨 Design System
            </summary>
            <div style="padding: 8px 0 0 16px;">
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-component-issues" style="margin-right: 6px;">
                <span>Component Issues</span>
              </label>
              <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="export-inconsistencies" style="margin-right: 6px;">
                <span>Design Inconsistencies</span>
              </label>
            </div>
          </details>
          
          <!-- Meta Options -->
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
            <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
              <input type="checkbox" id="export-summary" style="margin-right: 6px;">
              <span>Include Summary Statistics</span>
            </label>
            <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
              <input type="checkbox" id="export-context" checked style="margin-right: 6px;">
              <span>Include File Context</span>
            </label>
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-size: 13px;">Format:</label>
          <select id="export-format" style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 4px; color: #e2e8f0;">
            <option value="json">JSON (for tools)</option>
            <option value="markdown">Markdown (for docs/AI)</option>
            <option value="csv">CSV (spreadsheet)</option>
            <option value="yaml">YAML (for configs)</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="this.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #333; border: none; border-radius: 4px; color: #e2e8f0; cursor: pointer;">Cancel</button>
          <button id="export-confirm" style="padding: 8px 16px; background: #3b82f6; border: none; border-radius: 4px; color: white; cursor: pointer;">Export</button>
        </div>
      `;
      
      // Add preset selection function
      window.selectExportPreset = function(preset) {
        // Clear all checkboxes first
        dialog.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        if (preset === 'ai-fix') {
          // For AI: Focus on issues that need fixing
          document.getElementById('export-9rules').checked = true;
          document.getElementById('export-critical').checked = true;
          document.getElementById('export-contract-violations').checked = true;
          document.getElementById('export-rule-violations').checked = true;
          document.getElementById('export-context').checked = true;
          document.getElementById('export-format').value = 'markdown';
        } else if (preset === 'review') {
          // For code review: Include violations and suggestions
          document.getElementById('export-critical').checked = true;
          document.getElementById('export-contract-violations').checked = true;
          document.getElementById('export-missing-contracts').checked = true;
          document.getElementById('export-contract-suggestions').checked = true;
          document.getElementById('export-business-rules').checked = true;
          document.getElementById('export-summary').checked = true;
          document.getElementById('export-format').value = 'markdown';
        } else if (preset === 'report') {
          // Full report: Everything
          dialog.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          document.getElementById('export-format').value = 'json';
        }
      };
      
      document.body.appendChild(dialog);
      
      document.getElementById('export-confirm').onclick = async () => {
        const issuesOnly = document.getElementById('export-issues').checked;
        const includeSummary = document.getElementById('export-summary').checked;
        const fullReport = document.getElementById('export-full').checked;
        const format = document.getElementById('export-format').value;
        
        try {
          showLogPanel('Gathering validation data...');
          
          // Fetch data based on selection
          let exportData = {
            timestamp: new Date().toISOString(),
            project: document.getElementById('projectPath')?.textContent || currentProject || 'unknown'
          };
          
          if (issuesOnly || fullReport) {
            const [validationRes, healthRes] = await Promise.all([
              fetch('/api/validation-report').then(r => r.json()).catch(() => ({})),
              fetch('/api/health-score').then(r => r.json()).catch(() => ({}))
            ]);
            
            if (issuesOnly) {
              // Extract only issues for AI processing
              exportData.issues = validationRes?.issues || [];
              exportData.totalIssues = validationRes?.totalIssues || 0;
              exportData.criticalCount = validationRes?.criticalCount || 0;
              exportData.warningCount = validationRes?.warningCount || 0;
            } else {
              exportData.fullReport = validationRes;
              exportData.healthScore = healthRes;
            }
          }
          
          if (includeSummary) {
            const healthRes = await fetch('/api/health-score').then(r => r.json()).catch(() => ({}));
            exportData.summary = healthRes;
          }
          
          // Convert to selected format
          let content, mimeType, extension;
          
          if (format === 'markdown') {
            content = convertToMarkdown(exportData);
            mimeType = 'text/markdown';
            extension = 'md';
          } else if (format === 'csv' && issuesOnly) {
            content = convertToCSV(exportData.issues || []);
            mimeType = 'text/csv';
            extension = 'csv';
          } else {
            content = JSON.stringify(exportData, null, 2);
            mimeType = 'application/json';
            extension = 'json';
          }
          
          // Download file
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `validation-${issuesOnly ? 'issues' : 'report'}-${Date.now()}.${extension}`;
          a.click();
          URL.revokeObjectURL(url);
          
          dialog.remove();
          addLog('✅ Report exported successfully!', 'success');
        } catch (error) {
          console.error('Export failed:', error);
          addLog(`❌ Export failed: ${error.message}`, 'error');
        }
      };
    }
    
    function convertToMarkdown(data) {
      let md = `# Validation Report\n\n`;
      md += `**Generated:** ${data.timestamp}\n`;
      md += `**Project:** ${data.project}\n\n`;
      
      if (data.issues && data.issues.length > 0) {
        md += `## Issues (${data.totalIssues || data.issues.length})\n\n`;
        md += `- Critical: ${data.criticalCount || 0}\n`;
        md += `- Warnings: ${data.warningCount || 0}\n\n`;
        
        data.issues.forEach(issue => {
          md += `### ${issue.severity || 'Issue'}: ${issue.rule || issue.title || 'Unknown'}\n`;
          if (issue.file) md += `**File:** ${issue.file}${issue.line ? ':' + issue.line : ''}\n`;
          md += `${issue.message || issue.description || ''}\n\n`;
        });
      }
      
      if (data.summary) {
        md += `## Summary\n\n`;
        md += `- Score: ${data.summary.score}%\n`;
        md += `- Errors: ${data.summary.errors}\n`;
        md += `- Warnings: ${data.summary.warnings}\n\n`;
      }
      
      return md;
    }
    
    function convertToCSV(issues) {
      if (!issues || issues.length === 0) return 'No issues to export';
      
      const headers = ['Severity', 'Rule', 'File', 'Line', 'Message'];
      const rows = issues.map(i => [
        i.severity || '',
        i.rule || i.title || '',
        i.file || '',
        i.line || '',
        (i.message || i.description || '').replace(/"/g, '""')
      ]);
      
      return [
        headers.join(','),
        ...rows.map(r => r.map(c => `"${c}"`).join(','))
      ].join('\n');
    }
    
    function loadExportView() {
      const mainContent = document.getElementById('mainContent');
      const sidebar = document.getElementById('sidebar');
      
      // Hide query panel
      const queryPanel = document.querySelector('.query-panel');
      if (queryPanel) queryPanel.style.display = 'none';
      
      // Clear sidebar
      if (sidebar) {
        sidebar.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">📤 Export Presets</h3>
            <button onclick="selectExportPreset('ai-fix')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #1e40af; border: none; border-radius: 6px; color: white; cursor: pointer;">
              🤖 For AI Fixing
            </button>
            <button onclick="selectExportPreset('review')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #7c3aed; border: none; border-radius: 6px; color: white; cursor: pointer;">
              📝 Code Review
            </button>
            <button onclick="selectExportPreset('report')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #059669; border: none; border-radius: 6px; color: white; cursor: pointer;">
              📊 Full Report
            </button>
            <button onclick="selectExportPreset('custom')" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: none; border-radius: 6px; color: white; cursor: pointer;">
              ⚙️ Custom Selection
            </button>
          </div>
        `;
      }
      
      mainContent.innerHTML = `
        <div style="padding: 20px;">
          <h2 style="margin-bottom: 30px;">📤 Export Validation Data</h2>
          
          <!-- Export Form -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            
            <!-- Left Column: Data Selection -->
            <div>
              <h3 style="margin-bottom: 15px; color: #60a5fa;">Data Selection</h3>
              
              <!-- Code Quality Section -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="checkbox" id="export-code-quality-all" onchange="toggleSection('code-quality')" style="margin-right: 8px;">
                  <strong>✅ Code Quality</strong>
                </label>
                <div id="code-quality-options" style="padding-left: 24px;">
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="code-quality" id="export-9rules-all" style="margin-right: 6px;">
                    <span>All 9 Core Rules</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="code-quality" id="export-critical-only" style="margin-right: 6px;">
                    <span>Critical Issues Only</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="code-quality" id="export-registry" style="margin-right: 6px;">
                    <span>Registry Usage (Rule 6)</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="code-quality" id="export-complexity" style="margin-right: 6px;">
                    <span>High Complexity Functions</span>
                  </label>
                </div>
              </div>
              
              <!-- Contracts Section -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="checkbox" id="export-contracts-all" onchange="toggleSection('contracts')" style="margin-right: 8px;">
                  <strong>📋 Contracts</strong>
                </label>
                <div id="contracts-options" style="padding-left: 24px;">
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="contracts" id="export-contract-violations" style="margin-right: 6px;">
                    <span>All Violations</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="contracts" id="export-missing-contracts" style="margin-right: 6px;">
                    <span>Missing Contracts</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="contracts" id="export-contract-by-table" style="margin-right: 6px;">
                    <span>Group by Table</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="contracts" id="export-contract-by-hook" style="margin-right: 6px;">
                    <span>Group by Hook</span>
                  </label>
                </div>
              </div>
              
              <!-- Business Logic Section -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="checkbox" id="export-business-all" onchange="toggleSection('business')" style="margin-right: 8px;">
                  <strong>🏢 Business Logic</strong>
                </label>
                <div id="business-options" style="padding-left: 24px;">
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="business" id="export-business-rules" style="margin-right: 6px;">
                    <span>Business Rules</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="business" id="export-boundary-violations" style="margin-right: 6px;">
                    <span>Boundary Violations</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="business" id="export-data-flow" style="margin-right: 6px;">
                    <span>Data Flow Issues</span>
                  </label>
                </div>
              </div>
              
              <!-- Design System Section -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="checkbox" id="export-design-all" onchange="toggleSection('design')" style="margin-right: 8px;">
                  <strong>🎨 Design System</strong>
                </label>
                <div id="design-options" style="padding-left: 24px;">
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="design" id="export-component-issues" style="margin-right: 6px;">
                    <span>Component Issues</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="design" id="export-inconsistencies" style="margin-right: 6px;">
                    <span>Style Inconsistencies</span>
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" class="design" id="export-missing-patterns" style="margin-right: 6px;">
                    <span>Missing Patterns</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Right Column: Export Options -->
            <div>
              <h3 style="margin-bottom: 15px; color: #60a5fa;">Export Options</h3>
              
              <!-- Filters -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Filters</h4>
                <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                  Severity:
                  <select id="export-severity-filter" style="width: 100%; padding: 6px; background: #0f0f0f; border: 1px solid #333; border-radius: 4px; color: #e2e8f0; margin-top: 4px;">
                    <option value="all">All Severities</option>
                    <option value="critical">Critical Only</option>
                    <option value="error">Errors & Critical</option>
                    <option value="warning">Warnings & Above</option>
                  </select>
                </label>
                <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                  Files:
                  <input type="text" id="export-file-filter" placeholder="e.g., components/*, *.hook.ts" style="width: 100%; padding: 6px; background: #0f0f0f; border: 1px solid #333; border-radius: 4px; color: #e2e8f0; margin-top: 4px;">
                </label>
                <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                  Max Issues:
                  <input type="number" id="export-max-issues" value="1000" style="width: 100%; padding: 6px; background: #0f0f0f; border: 1px solid #333; border-radius: 4px; color: #e2e8f0; margin-top: 4px;">
                </label>
              </div>
              
              <!-- Format Options -->
              <div style="background: rgba(30, 30, 40, 0.6); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Format</h4>
                <select id="export-format" style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 4px; color: #e2e8f0; margin-bottom: 10px;">
                  <option value="json">JSON (Structured Data)</option>
                  <option value="markdown">Markdown (For AI/Docs)</option>
                  <option value="csv">CSV (Spreadsheet)</option>
                  <option value="yaml">YAML (Configuration)</option>
                  <option value="html">HTML (Report)</option>
                </select>
                
                <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                  <input type="checkbox" id="export-include-context" checked style="margin-right: 6px;">
                  <span>Include File Context</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                  <input type="checkbox" id="export-include-suggestions" checked style="margin-right: 6px;">
                  <span>Include Fix Suggestions</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                  <input type="checkbox" id="export-include-stats" style="margin-right: 6px;">
                  <span>Include Summary Statistics</span>
                </label>
              </div>
              
              <!-- Export Button -->
              <button onclick="performExport()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer; font-weight: 600;">
                Export Selected Data
              </button>
              
              <!-- Preview Area -->
              <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Preview</h4>
                <div id="export-preview" style="background: #0f0f0f; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; color: #64748b;">
                  Select data to see preview...
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add helper functions
      window.toggleSection = function(section) {
        const checkbox = document.getElementById(`export-${section}-all`);
        const checkboxes = document.querySelectorAll(`.${section}`);
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updatePreview();
      };
      
      window.selectExportPreset = function(preset) {
        // Clear all
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        if (preset === 'ai-fix') {
          document.getElementById('export-critical-only').checked = true;
          document.getElementById('export-contract-violations').checked = true;
          document.getElementById('export-boundary-violations').checked = true;
          document.getElementById('export-severity-filter').value = 'error';
          document.getElementById('export-format').value = 'markdown';
          document.getElementById('export-include-suggestions').checked = true;
        } else if (preset === 'review') {
          document.getElementById('export-code-quality-all').checked = true;
          toggleSection('code-quality');
          document.getElementById('export-contracts-all').checked = true;
          toggleSection('contracts');
          document.getElementById('export-format').value = 'markdown';
          document.getElementById('export-include-stats').checked = true;
        } else if (preset === 'report') {
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          document.getElementById('export-format').value = 'json';
        }
        updatePreview();
      };
      
      window.updatePreview = function() {
        const preview = document.getElementById('export-preview');
        const selected = [];
        
        if (document.getElementById('export-critical-only')?.checked) selected.push('Critical Issues');
        if (document.getElementById('export-contract-violations')?.checked) selected.push('Contract Violations');
        if (document.getElementById('export-business-rules')?.checked) selected.push('Business Rules');
        
        if (selected.length > 0) {
          preview.innerHTML = `Will export: ${selected.join(', ')}\\n\\nFormat: ${document.getElementById('export-format').value}\\nEstimated size: ~${Math.floor(Math.random() * 50 + 10)}KB`;
        } else {
          preview.innerHTML = 'Select data to export...';
        }
      };
      
      // Add event listeners
      document.querySelectorAll('input[type="checkbox"], select').forEach(el => {
        el.addEventListener('change', updatePreview);
      });
    }
    
    function viewChanges() {
      // Show recent file changes
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <div style="padding: 20px;">
          <h2>📝 Recent File Changes</h2>
          <div style="margin-top: 20px; color: #64748b;">
            <p>Checking for recent changes...</p>
          </div>
        </div>
      `;
      
      fetch('/api/file-changes').then(res => res.json()).then(data => {
        if (data.changes && data.changes.length > 0) {
          mainContent.innerHTML = `
            <div style="padding: 20px;">
              <h2>📝 Recent File Changes</h2>
              <div style="margin-top: 20px;">
                ${data.changes.map(change => `
                  <div style="padding: 10px; background: rgba(30,30,40,0.6); margin-bottom: 10px; border-radius: 6px;">
                    <strong>${change.file}</strong>
                    <span style="color: #64748b; margin-left: 10px;">${change.type}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        } else {
          mainContent.innerHTML = `
            <div style="padding: 20px;">
              <h2>📝 Recent File Changes</h2>
              <div style="margin-top: 20px; color: #64748b;">
                <p>No recent changes detected.</p>
              </div>
            </div>
          `;
        }
      });
    }
    
    // Initialize on load
    init();
    // Initialize dashboard
    setTimeout(() => {
      document.getElementById('mode-description').textContent = 'Daily workflow: Start with 🏠 Overview → Run ✅ Health Check → Focus on specific areas below';
    }, 500);
    
    // Global functions for enhanced components
    
    // Nine Rules View functions
    function toggleNineRulesGroup(groupId) {
      const group = document.getElementById(groupId);
      const arrow = document.getElementById(groupId + '-arrow');
      if (group && arrow) {
        if (group.style.display === 'none') {
          group.style.display = 'block';
          arrow.textContent = '▼';
        } else {
          group.style.display = 'none';
          arrow.textContent = '▶';
        }
      }
    }
    
    function reloadNineRulesView(groupBy) {
      // Updated to use loadCodeQuality for consolidated view
      if (window.loadCodeQuality) {
        window.loadCodeQuality(groupBy, false); // false = don't run validation, just reload view
      } else if (window.loadNineRules) {
        // Fallback for compatibility
        window.loadNineRules(groupBy, false);
      }
    }
    
    // Contract View functions  
    function toggleGroup(groupId) {
      const group = document.getElementById(groupId);
      const arrow = document.getElementById(groupId + '-arrow');
      if (group && arrow) {
        if (group.style.display === 'none') {
          group.style.display = 'block';
          arrow.textContent = '▼';
        } else {
          group.style.display = 'none';
          arrow.textContent = '▶';
        }
      }
    }
    
    function reloadContractView(groupBy) {
      if (window.loadContractValidation) {
        window.loadContractValidation(groupBy, false); // false = don't run validation, just reload view
      }
    }
  </script>
</body>
</html>