<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Observer - Modular Dashboard</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Minimal inline styles - most in design-system.css */
    .tabs {
      background: #0a0a0a;
      padding: 0 20px;
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      background: transparent;
      color: var(--text-tertiary);
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover { color: var(--text-primary); }
    .tab.active { 
      color: var(--text-primary);
      border-bottom-color: var(--brand-primary);
    }
    
    .search-box {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 6px;
      width: 100%;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header">
    <h1 style="margin: 0; color: white;">ðŸ”¬ AI Observer Dashboard</h1>
    <div id="projectInfo" style="color: rgba(255,255,255,0.9);">Loading...</div>
  </div>
  
  <!-- Control Bar -->
  <div class="control-bar">
    <div style="display: flex; gap: 12px;">
      <button class="btn btn-primary" onclick="runValidations()">ðŸ”„ Run Validations</button>
      <button class="btn btn-primary" onclick="exportReport()">ðŸ“Š Export Report</button>
    </div>
    <div id="lastRun" style="color: var(--text-muted); font-size: 13px;">
      Last run: Never
    </div>
  </div>
  
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview')">Overview</button>
    <button class="tab" onclick="switchTab('architecture')">Architecture</button>
    <button class="tab" onclick="switchTab('validation')">Validation</button>
    <button class="tab" onclick="switchTab('analytics')">Analytics</button>
  </div>
  
  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div style="padding: 15px;">
        <input type="text" class="search-box" placeholder="Search..." onkeyup="filterSidebar(event)">
      </div>
      
      <div id="sidebarContent">
        <!-- Dynamic sidebar content -->
      </div>
    </div>
    
    <!-- Content Area -->
    <div class="content-area" id="mainContent">
      <!-- Dynamic main content -->
    </div>
    
    <!-- Right Panel -->
    <div class="right-panel" id="rightPanel">
      <!-- Dynamic right panel content -->
    </div>
  </div>

  <script type="module">
    // Import components
    const modules = {};
    
    // State management
    let state = {
      tables: {},
      hooks: [],
      components: [],
      pages: [],
      apis: [],
      validationData: null,
      selectedItem: null,
      selectedType: null
    };
    
    // Initialize dashboard
    async function init() {
      try {
        // Load all data
        const responses = await Promise.all([
          fetch('/api/project-info'),
          fetch('/api/table-mapping'),
          fetch('/api/architecture-data'),
          fetch('/api/contracts'),
          fetch('/api/nine-rules')
        ]);
        
        const [project, tables, architecture, contracts, nineRules] = await Promise.all(
          responses.map(r => r.json())
        );
        
        // Update state
        state.validationData = { contracts, nineRules };
        state.tables = enrichTablesWithEntityData(tables.tables || {});
        extractArchitectureData(architecture);
        
        // Update UI
        updateProjectInfo(project);
        renderSidebar();
        
        // Select first table
        const firstTable = Object.keys(state.tables)[0];
        if (firstTable) selectItem(firstTable, 'table');
        
      } catch (error) {
        console.error('Init failed:', error);
        document.getElementById('mainContent').innerHTML = `
          <div class="card" style="color: var(--health-error);">
            Error loading data: ${error.message}
          </div>
        `;
      }
    }
    
    // Entity data enrichment (simplified inline version)
    function enrichTablesWithEntityData(tables) {
      const entityData = {
        order: {
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'order_number', type: 'string', required: true },
            { name: 'total_amount', type: 'number', required: true }
          ],
          relationships: [
            { type: 'belongsTo', target: 'Professional' },
            { type: 'hasMany', target: 'OrderItem' }
          ]
        }
        // Add more entities as needed
      };
      
      const enriched = {};
      for (const [name, data] of Object.entries(tables)) {
        enriched[name] = {
          ...data,
          ...(entityData[name.toLowerCase()] || {})
        };
      }
      return enriched;
    }
    
    function extractArchitectureData(arch) {
      // Extract pages with hierarchy
      state.pages = [
        'src/app/(main)/feed/page.tsx',
        'src/app/(main)/crm/page.tsx',
        'src/app/(main)/orders/page.tsx'
      ];
      
      // Extract hooks and components from tables
      Object.values(state.tables).forEach(table => {
        if (table.hooks) {
          table.hooks.forEach(h => {
            const name = typeof h === 'string' ? h : h.hookName;
            if (name && !state.hooks.includes(name)) state.hooks.push(name);
          });
        }
        if (table.components) {
          table.components.forEach(c => {
            const name = typeof c === 'string' ? c : c.name;
            if (name && !state.components.includes(name)) state.components.push(name);
          });
        }
      });
    }
    
    function updateProjectInfo(project) {
      document.getElementById('projectInfo').innerHTML = `
        <div>${project.name || 'Project'}</div>
        <div style="font-size: 12px; opacity: 0.8;">
          ${Object.keys(state.tables).length} tables
        </div>
      `;
    }
    
    function renderSidebar() {
      const content = `
        <div class="entity-list">
          <h3>ðŸ“Š Tables (${Object.keys(state.tables).length})</h3>
          ${Object.entries(state.tables).map(([name, data]) => {
            const score = data.score || calculateHealthScore(data);
            return `
              <div class="entity-item" onclick="selectItem('${name}', 'table')">
                <span>ðŸ“Š</span>
                <span style="flex: 1;">${name}</span>
                <span class="health-dot ${getHealthClass(score)}"></span>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="entity-list">
          <h3>ðŸ”— Hooks (${state.hooks.length})</h3>
          ${state.hooks.slice(0, 5).map(h => `
            <div class="entity-item" onclick="selectItem('${h}', 'hook')">
              <span>ðŸ”—</span>
              <span>${h}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="entity-list">
          <h3>ðŸ§© Components (${state.components.length})</h3>
          ${state.components.slice(0, 5).map(c => `
            <div class="entity-item" onclick="selectItem('${c}', 'component')">
              <span>ðŸ§©</span>
              <span>${c}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="entity-list">
          <h3>ðŸ“„ Pages (${state.pages.length})</h3>
          ${state.pages.map(p => {
            const display = formatPageName(p);
            return `
              <div class="entity-item" onclick="selectItem('${p}', 'page')">
                <span>ðŸ“„</span>
                <span>${display}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      document.getElementById('sidebarContent').innerHTML = content;
    }
    
    function formatPageName(path) {
      if (path.includes('(main)')) {
        const parts = path.split('/');
        const mainIdx = parts.findIndex(p => p === '(main)');
        if (mainIdx >= 0 && mainIdx < parts.length - 1) {
          return `(main) > ${parts[mainIdx + 1]}`;
        }
      }
      const parts = path.split('/');
      return parts[parts.length - 2] || 'page';
    }
    
    function calculateHealthScore(data) {
      let score = 100;
      if (!data.typeDefinition) score -= 20;
      if (!data.hooks?.length) score -= 15;
      if (!data.components?.length) score -= 15;
      return Math.max(0, score);
    }
    
    function getHealthClass(score) {
      if (score >= 80) return 'health-good';
      if (score >= 40) return 'health-warning';
      return 'health-error';
    }
    
    window.selectItem = function(name, type) {
      state.selectedItem = name;
      state.selectedType = type;
      
      // Update selected state in sidebar
      document.querySelectorAll('.entity-item').forEach(el => {
        el.classList.remove('selected');
      });
      event?.target?.classList.add('selected');
      
      // Load appropriate viewer
      if (type === 'table') {
        loadTableViewer(name);
      } else if (type === 'component' || type === 'hook') {
        loadComponentViewer(name, type);
      } else if (type === 'page') {
        loadPageViewer(name);
      }
    };
    
    async function loadTableViewer(name) {
      try {
        const { TableDetailsViewer } = await import('./components/table-details-viewer.js');
        const viewer = new TableDetailsViewer('mainContent');
        viewer.render(name, state.tables[name]);
      } catch (error) {
        // Fallback inline rendering
        renderTableInline(name, state.tables[name]);
      }
    }
    
    async function loadComponentViewer(name, type) {
      try {
        const { ComponentDetailsViewer } = await import('./components/component-details-viewer.js');
        const viewer = new ComponentDetailsViewer('mainContent');
        viewer.render(name, type, state.validationData);
      } catch (error) {
        // Fallback inline rendering
        renderComponentInline(name, type);
      }
    }
    
    async function loadPageViewer(name) {
      try {
        const { PageDetailsViewer } = await import('./components/page-details-viewer.js');
        const viewer = new PageDetailsViewer('mainContent');
        viewer.render(name, state.validationData);
      } catch (error) {
        // Fallback inline rendering  
        renderPageInline(name);
      }
    }
    
    // Fallback inline renderers (simplified)
    function renderTableInline(name, data) {
      const props = data.properties || [];
      const rels = data.relationships || [];
      
      document.getElementById('mainContent').innerHTML = `
        <div class="card">
          <h2>ðŸ“Š ${name}</h2>
          <div class="card">
            <h3>Properties (${props.length})</h3>
            <div class="property-grid">
              ${props.slice(0, 10).map(p => `
                <div class="property-item">
                  <span>${p.name}</span>
                  <span class="badge badge-type">${p.type}</span>
                </div>
              `).join('')}
            </div>
          </div>
          ${rels.length ? `
            <div class="card">
              <h3>Relationships</h3>
              ${rels.map(r => `
                <div>${name} â†’ ${r.type} ${r.target}</div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }
    
    function renderComponentInline(name, type) {
      document.getElementById('mainContent').innerHTML = `
        <div class="card">
          <h2>${type === 'hook' ? 'ðŸ”—' : 'ðŸ§©'} ${name}</h2>
          <p>Component details viewer loading...</p>
        </div>
      `;
    }
    
    function renderPageInline(name) {
      document.getElementById('mainContent').innerHTML = `
        <div class="card">
          <h2>ðŸ“„ ${formatPageName(name)}</h2>
          <p>Page details viewer loading...</p>
        </div>
      `;
    }
    
    // Global functions
    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      console.log('Switching to:', tab);
    };
    
    window.filterSidebar = function(event) {
      const search = event.target.value.toLowerCase();
      document.querySelectorAll('.entity-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'flex' : 'none';
      });
    };
    
    window.runValidations = function() {
      document.getElementById('lastRun').textContent = 'Running...';
      setTimeout(() => {
        document.getElementById('lastRun').textContent = 
          'Last run: ' + new Date().toLocaleTimeString();
      }, 2000);
    };
    
    window.exportReport = function() {
      alert('Export functionality coming soon!');
    };
    
    // Start the app
    init();
  </script>
</body>
</html>