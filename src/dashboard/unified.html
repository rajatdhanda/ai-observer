<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Observer - Unified Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e2e8f0;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #667eea;
    }
    
    /* Loading animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }
    
    /* Button animations */
    .action-btn {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    /* Card animations */
    .card {
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    /* Responsive design */
    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100% !important;
        height: 200px !important;
      }
      
      .right-panel {
        display: none !important;
      }
    }
    
    /* Accessibility */
    .tab:focus,
    .action-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }
    
    /* Print styles */
    @media print {
      .header,
      .mode-bar,
      .tabs,
      .sidebar {
        display: none !important;
      }
      
      .main-container {
        height: auto !important;
      }
      
      .content-area {
        padding: 0 !important;
      }
    }
  </style>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #0f0f0f;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  ">
    <div style="text-align: center; color: #9ca3af;">
      <div class="loading" style="margin-bottom: 16px;"></div>
      <div>Loading AI Observer Dashboard...</div>
    </div>
  </div>

  <!-- Component Scripts (Load in correct order) -->
  <script src="/components/index.js"></script>
  <script src="/components/validation-service.js"></script>
  <script src="/components/severity-badge.js"></script>
  <script src="/components/entity-data-provider.js"></script>
  <script src="/components/sidebar-navigator.js"></script>
  <script src="/components/control-bar.js"></script>
  <script src="/components/table-details-viewer.js"></script>
  <script src="/components/hook-details-viewer.js"></script>
  <script src="/components/overview-component.js"></script>
  <script src="/components/unified-dashboard.js"></script>

  <script>
    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Dashboard Error:', event.error);
      
      // Show error message to user
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        z-index: 10000;
        max-width: 300px;
      `;
      errorDiv.innerHTML = `
        <div style="font-weight: 500; margin-bottom: 4px;">Error</div>
        <div style="font-size: 12px;">${event.error?.message || 'Unknown error'}</div>
        <button onclick="this.parentElement.remove()" style="
          position: absolute;
          top: 4px;
          right: 4px;
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 16px;
        ">×</button>
      `;
      
      document.body.appendChild(errorDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentElement) {
          errorDiv.remove();
        }
      }, 5000);
    });

    // Global function to load current data (used by control bar)
    window.loadCurrentData = async function() {
      try {
        // Reload sidebar data
        if (window.sidebarNavigatorInstance) {
          await window.sidebarNavigatorInstance.loadData();
        }
        
        // Reload current tab content
        if (window.unifiedDashboard) {
          await window.unifiedDashboard.loadCurrentTab();
        }
      } catch (error) {
        console.error('Error loading current data:', error);
      }
    };

    // Global function for selecting items (used by sidebar)
    window.selectItem = async function(name, type) {
      try {
        const mainContent = document.getElementById('mainContent');
        if (!mainContent) return;

        // Show loading state
        mainContent.innerHTML = `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #9ca3af;
          ">
            <div style="text-align: center;">
              <div class="loading" style="margin-bottom: 16px;"></div>
              <div>Loading ${type}: ${name}...</div>
            </div>
          </div>
        `;

        // Load entity data
        const response = await fetch('/api/entity-data');
        const data = await response.json();
        
        // Load validation data
        const validationResponse = await fetch('/api/validation-summary');
        const validationData = await validationResponse.json();

        // Render based on type
        switch(type) {
          case 'table':
            if (window.tableDetailsViewer) {
              window.tableDetailsViewer.render(name, data.tables[name], validationData);
            }
            break;
            
          case 'hook':
            if (window.hookDetailsViewer) {
              window.hookDetailsViewer.render(name, data.hooks[name], validationData);
            }
            break;
            
          case 'component':
          case 'page':
            // Handle component/page viewing
            mainContent.innerHTML = `
              <div style="padding: 20px;">
                <h2 style="color: #f8fafc; margin-bottom: 16px;">${type}: ${name}</h2>
                <div style="color: #9ca3af;">
                  Detailed ${type} viewer coming soon...
                </div>
              </div>
            `;
            break;
            
          default:
            mainContent.innerHTML = `
              <div style="padding: 20px; color: #9ca3af;">
                Unknown entity type: ${type}
              </div>
            `;
        }

        // Show query panel for tables
        const queryPanel = document.getElementById('queryPanel');
        if (queryPanel && type === 'table') {
          queryPanel.style.display = 'block';
          // Load query information here if available
        }

      } catch (error) {
        console.error('Error selecting item:', error);
        
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
          mainContent.innerHTML = `
            <div style="
              background: #ef444410;
              border: 1px solid #ef444430;
              border-radius: 8px;
              padding: 20px;
              color: #ef4444;
              text-align: center;
            ">
              <div style="font-size: 24px; margin-bottom: 12px;">⚠️</div>
              <div>Failed to load ${type}: ${name}</div>
              <div style="font-size: 12px; margin-top: 8px; color: #9ca3af;">
                ${error.message}
              </div>
            </div>
          `;
        }
      }
    };

    // Initialize viewers after components load
    window.addEventListener('load', () => {
      // Initialize detail viewers
      if (window.TableDetailsViewer) {
        window.tableDetailsViewer = new window.TableDetailsViewer('mainContent');
      }
      
      if (window.HookDetailsViewer) {
        window.hookDetailsViewer = new window.HookDetailsViewer('mainContent');
      }

      // Hide loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => loadingOverlay.remove(), 300);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      // Alt/Cmd + number to switch tabs
      if ((event.altKey || event.metaKey) && event.key >= '1' && event.key <= '8') {
        event.preventDefault();
        const tabIndex = parseInt(event.key) - 1;
        const tabs = ['overview', 'unified', 'code-quality', 'contracts', 'business', 'design', 'contract-tests', 'export'];
        if (tabs[tabIndex] && window.unifiedDashboard) {
          window.unifiedDashboard.switchTab(tabs[tabIndex]);
        }
      }
      
      // Ctrl/Cmd + R to run analysis
      if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
        event.preventDefault();
        if (window.controlBar) {
          window.controlBar.triggerRun();
        }
      }
    });

    // Theme detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
      // Add light theme support if needed
      console.log('Light theme preference detected');
    }
  </script>
</body>
</html>