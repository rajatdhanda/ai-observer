<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Observer - Working Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e2e8f0;
      height: 100vh;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .control-bar {
      background: #1a1a1a;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    
    .tabs {
      background: #0a0a0a;
      padding: 0 20px;
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #252525;
    }
    
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #f8fafc;
    }
    
    .tab.active {
      color: #f8fafc;
      border-bottom-color: #667eea;
    }
    
    .action-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    .action-btn:hover {
      background: #764ba2;
    }
    
    .container {
      display: flex;
      height: calc(100vh - 150px);
    }
    
    .right-panel {
      width: 400px;
      background: #1a1a1a;
      border-left: 1px solid #333;
      overflow-y: auto;
      padding: 20px;
    }
    
    .sidebar {
      width: 300px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      overflow-y: auto;
    }
    
    .entity-list {
      padding: 15px;
      border-bottom: 1px solid #252525;
    }
    
    .entity-list h3 {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .entity-item {
      padding: 8px 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .entity-item:hover {
      background: #252525;
    }
    
    .entity-item.selected {
      background: #252525;
      border-left: 3px solid #667eea;
    }
    
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .table-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #252525;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-item:hover {
      background: #252525;
    }
    
    .table-item.selected {
      background: #252525;
      border-left: 3px solid #3b82f6;
    }
    
    .health-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .health-good { background: #10b981; }
    .health-warning { background: #f59e0b; }
    .health-error { background: #ef4444; }
    
    .health-score {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #0f0f0f;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .score-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
    }
    
    .score-high { background: #10b98120; color: #10b981; border: 2px solid #10b981; }
    .score-medium { background: #f59e0b20; color: #f59e0b; border: 2px solid #f59e0b; }
    .score-low { background: #ef444420; color: #ef4444; border: 2px solid #ef4444; }
    
    .score-details {
      flex: 1;
    }
    
    .score-items {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .check-item {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #252525;
    }
    
    .check-pass { color: #10b981; }
    .check-fail { color: #ef4444; }
    
    .card {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
    
    .error {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px;
    }
    
    .property-grid {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }
    
    .property-item {
      background: #0a0a0a;
      padding: 12px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .type-badge {
      background: #252525;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
      color: #94a3b8;
    }
    
    h2 { 
      color: #f8fafc; 
      margin-bottom: 16px; 
    }
    
    h3 { 
      color: #e2e8f0; 
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #252525;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 style="font-size: 20px; color: white;">üîç AI Observer - Unified Control Center</h1>
    <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
      <span>Project: <strong id="projectName">Loading...</strong></span>
      <span style="margin-left: 20px;">Framework: <strong id="frameworkName">Next.js</strong></span>
      <span style="margin-left: 20px;">Tables: <strong id="tableCount">0</strong></span>
    </div>
  </div>

  <!-- Control Bar -->
  <div class="control-bar">
    <div style="display: flex; gap: 10px;">
      <button class="action-btn" onclick="runAllValidations()">üöÄ Run All</button>
      <button class="action-btn" onclick="exportReport()">üìä Export</button>
      <button class="action-btn" onclick="runContractTests()" style="background: #8b5cf6;">üß™ Test Contracts</button>
    </div>
    <div style="color: #64748b; font-size: 12px;">
      <span id="lastRunStatus">Last run: Never</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('overview')">üè† Overview</div>
    <div class="tab" onclick="switchTab('unified')" style="background: #8b5cf6;">üéØ Unified</div>
    <div class="tab" onclick="switchTab('code-quality')">‚úÖ Code Quality</div>
  </div>

  <div class="container">
    <div class="sidebar" id="sidebar">
      <!-- Search -->
      <div style="padding: 15px;">
        <input type="text" placeholder="Search..." style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #e2e8f0;" id="searchInput" onkeyup="filterSidebar()">
      </div>
      
      <!-- Tables List -->
      <div class="entity-list">
        <h3>Tables (<span id="tableListCount">0</span>)</h3>
        <div id="tablesList"></div>
      </div>
      
      <!-- Hooks List -->
      <div class="entity-list">
        <h3>üîó Hooks (<span id="hookCount">0</span>)</h3>
        <div id="hooksList"></div>
      </div>
      
      <!-- Components List -->
      <div class="entity-list">
        <h3>üß© Components (<span id="componentCount">0</span>)</h3>
        <div id="componentsList"></div>
      </div>
      
      <!-- API Routes List -->
      <div class="entity-list">
        <h3>üåê API Routes (<span id="apiCount">0</span>)</h3>
        <div id="apisList"></div>
      </div>
      
      <!-- Pages List -->
      <div class="entity-list">
        <h3>üìÑ Pages (<span id="pageCount">0</span>)</h3>
        <div id="pagesList"></div>
      </div>
      
      <!-- Validation Status -->
      <div class="entity-list" style="background: #1a1a1a; padding: 15px;">
        <h3 style="margin-bottom: 12px;">‚úÖ Validation Health</h3>
        <div style="display: flex; gap: 8px;">
          <div style="flex: 1; text-align: center; padding: 8px; background: #ef444420; border-radius: 6px; border: 1px solid #ef444440;">
            <div id="criticalCount" style="color: #ef4444; font-size: 18px; font-weight: bold;">0</div>
            <div style="color: #fca5a5; font-size: 10px;">Critical</div>
          </div>
          <div style="flex: 1; text-align: center; padding: 8px; background: #f59e0b20; border-radius: 6px; border: 1px solid #f59e0b40;">
            <div id="warningCount" style="color: #f59e0b; font-size: 18px; font-weight: bold;">0</div>
            <div style="color: #fcd34d; font-size: 10px;">Warning</div>
          </div>
          <div style="flex: 1; text-align: center; padding: 8px; background: #3b82f620; border-radius: 6px; border: 1px solid #3b82f640;">
            <div id="infoCount" style="color: #3b82f6; font-size: 18px; font-weight: bold;">0</div>
            <div style="color: #93c5fd; font-size: 10px;">Info</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="main" id="mainContent">
      <div class="loading">Select an item to view details</div>
    </div>
    
    <!-- Right Panel - Query Inspector -->
    <div class="right-panel" id="rightPanel">
      <h3 style="margin-bottom: 20px; color: #f8fafc;">üîç Query Inspector</h3>
      <div id="queryContent">
        <div style="color: #64748b; text-align: center; padding: 40px;">
          Select a table to view queries
        </div>
      </div>
    </div>
  </div>

  <script>
    let allData = {
      tables: {},
      hooks: [],
      components: [],
      apis: [],
      pages: []
    };
    let selectedItem = null;
    let selectedType = null;
    let validationData = null;
    
    // Entity Data Provider - provides hardcoded properties and relationships
    const entityDataProvider = {
      ENTITY_DATA: {
        order: {
          name: 'order',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'order_number', type: 'string', required: true },
            { name: 'order_date', type: 'string', required: true },
            { name: 'total_amount', type: 'number', required: true },
            { name: 'tax_amount', type: 'number' },
            { name: 'discount_amount', type: 'number' },
            { name: 'final_amount', type: 'number', required: true },
            { name: 'currency', type: "'INR'", required: true },
            { name: 'status', type: 'union' },
            { name: 'payment_status', type: 'string' },
            { name: 'payment_method', type: 'string' },
            { name: 'notes', type: 'string' },
            { name: 'invoice_url', type: 'string' },
            { name: 'items', type: 'array' },
            { name: 'client_id', type: 'string' },
            { name: 'service_date', type: 'string' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'Professional' },
            { type: 'hasMany', target: 'OrderItem' }
          ]
        },
        professional: {
          name: 'professional',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'user_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'business_name', type: 'string', required: true },
            { name: 'bio', type: 'string' },
            { name: 'specializations', type: 'string[]' },
            { name: 'experience_years', type: 'number' },
            { name: 'rating', type: 'number' },
            { name: 'total_reviews', type: 'number' },
            { name: 'hourly_rate', type: 'number' },
            { name: 'currency', type: 'string' },
            { name: 'is_verified', type: 'boolean' },
            { name: 'verification_date', type: 'string' },
            { name: 'available_hours', type: 'json' },
            { name: 'portfolio_urls', type: 'string[]' },
            { name: 'certifications', type: 'json' },
            { name: 'languages', type: 'string[]' },
            { name: 'location', type: 'string' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'User' },
            { type: 'hasMany', target: 'Order' },
            { type: 'hasMany', target: 'Service' },
            { type: 'hasMany', target: 'Appointment' }
          ]
        },
        client: {
          name: 'client',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'user_id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'first_name', type: 'string', required: true },
            { name: 'last_name', type: 'string', required: true },
            { name: 'email', type: 'string', required: true },
            { name: 'phone', type: 'string' },
            { name: 'address', type: 'json' },
            { name: 'date_of_birth', type: 'string' },
            { name: 'gender', type: 'string' },
            { name: 'notes', type: 'text' },
            { name: 'tags', type: 'string[]' },
            { name: 'total_visits', type: 'number' },
            { name: 'total_spent', type: 'number' },
            { name: 'last_visit', type: 'string' },
            { name: 'preferred_contact', type: 'string' },
            { name: 'emergency_contact', type: 'json' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'User' },
            { type: 'belongsTo', target: 'Professional' },
            { type: 'hasMany', target: 'Appointment' },
            { type: 'hasMany', target: 'Order' }
          ]
        },
        post: {
          name: 'post',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'user_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'content', type: 'text', required: true },
            { name: 'media_urls', type: 'string[]' },
            { name: 'media_type', type: 'string' },
            { name: 'visibility', type: 'string' },
            { name: 'likes_count', type: 'number' },
            { name: 'comments_count', type: 'number' },
            { name: 'shares_count', type: 'number' },
            { name: 'is_pinned', type: 'boolean' },
            { name: 'hashtags', type: 'string[]' },
            { name: 'mentions', type: 'string[]' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'User' },
            { type: 'hasMany', target: 'Comment' },
            { type: 'hasMany', target: 'PostEngagement' }
          ]
        },
        postengagement: {
          name: 'postengagement',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'post_id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'engagement_type', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true }
          ],
          relationships: [
            { type: 'belongsTo', target: 'Post' },
            { type: 'belongsTo', target: 'Professional' }
          ]
        },
        user: {
          name: 'user',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'email', type: 'string', required: true },
            { name: 'username', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'first_name', type: 'string' },
            { name: 'last_name', type: 'string' },
            { name: 'avatar_url', type: 'string' },
            { name: 'phone', type: 'string' },
            { name: 'role', type: 'string' },
            { name: 'is_active', type: 'boolean' },
            { name: 'is_verified', type: 'boolean' },
            { name: 'last_login', type: 'string' },
            { name: 'preferences', type: 'json' },
            { name: 'notification_settings', type: 'json' }
          ],
          relationships: [
            { type: 'hasOne', target: 'Professional' },
            { type: 'hasMany', target: 'Client' },
            { type: 'hasMany', target: 'Post' }
          ]
        },
        product: {
          name: 'product',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'name', type: 'string', required: true },
            { name: 'description', type: 'text' },
            { name: 'price', type: 'number', required: true },
            { name: 'currency', type: 'string' },
            { name: 'category', type: 'string' },
            { name: 'sku', type: 'string' },
            { name: 'stock_quantity', type: 'number' },
            { name: 'is_active', type: 'boolean' },
            { name: 'images', type: 'string[]' },
            { name: 'tags', type: 'string[]' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'Professional' },
            { type: 'hasMany', target: 'OrderItem' }
          ]
        },
        appointment: {
          name: 'appointment',
          properties: [
            { name: 'id', type: 'string', required: true },
            { name: 'client_id', type: 'string', required: true },
            { name: 'professional_id', type: 'string', required: true },
            { name: 'created_at', type: 'string', required: true },
            { name: 'updated_at', type: 'string', required: true },
            { name: 'appointment_date', type: 'string', required: true },
            { name: 'start_time', type: 'string', required: true },
            { name: 'end_time', type: 'string', required: true },
            { name: 'status', type: 'string', required: true },
            { name: 'service_id', type: 'string' },
            { name: 'notes', type: 'text' },
            { name: 'reminder_sent', type: 'boolean' },
            { name: 'cancellation_reason', type: 'string' }
          ],
          relationships: [
            { type: 'belongsTo', target: 'Client' },
            { type: 'belongsTo', target: 'Professional' },
            { type: 'belongsTo', target: 'Service' }
          ]
        }
      },
      
      getEntityData(tableName) {
        return this.ENTITY_DATA[tableName.toLowerCase()] || null;
      },
      
      enrichTableData(tableName, tableData) {
        const entityData = this.getEntityData(tableName);
        
        if (!entityData) {
          return tableData;
        }
        
        return {
          ...tableData,
          properties: entityData.properties,
          relationships: entityData.relationships,
          // Fix component count
          components: Array.isArray(tableData.components) 
            ? tableData.components.map(c => 
                typeof c === 'string' ? c : (c.componentName || c.name || 'Unknown')
              )
            : [],
          // Ensure hooks are properly structured
          hooks: Array.isArray(tableData.hooks)
            ? tableData.hooks
            : []
        };
      },
      
      parseLocation(location) {
        if (!location) return { file: '', line: null };
        
        const parts = location.split(':');
        const file = parts[0] || location;
        const line = parts[1] ? parseInt(parts[1], 10) : null;
        
        return { file, line };
      }
    };

    // Initialize the dashboard
    async function init() {
      console.log('Initializing dashboard...');
      
      try {
        // Load all data in parallel including validation
        const [projectRes, tablesRes, architectureRes, contractsRes, nineRulesRes] = await Promise.all([
          fetch('/api/project-info'),
          fetch('/api/table-mapping'),
          fetch('/api/architecture-data'),
          fetch('/api/contracts'),
          fetch('/api/nine-rules')
        ]);
        
        const projectData = await projectRes.json();
        const tablesData = await tablesRes.json();
        const architectureData = await architectureRes.json();
        const contractsData = await contractsRes.json();
        const nineRulesData = await nineRulesRes.json();
        
        // Store validation data
        validationData = {
          contracts: contractsData,
          nineRules: nineRulesData
        };
        
        // Update validation status in sidebar
        updateValidationStatus(contractsData, nineRulesData);
        
        // Update project info
        document.getElementById('projectName').textContent = projectData.name || 'Unknown';
        document.getElementById('tableCount').textContent = Object.keys(tablesData.tables || {}).length;
        
        // Store and enrich table data with properties and relationships
        const enrichedTables = {};
        for (const [tableName, tableData] of Object.entries(tablesData.tables || {})) {
          enrichedTables[tableName] = entityDataProvider.enrichTableData(tableName, tableData);
        }
        allData.tables = enrichedTables;
        
        // Extract architecture items from tables with proper data
        Object.values(allData.tables).forEach(table => {
          if (table.hooks) {
            table.hooks.forEach(hook => {
              const hookObj = typeof hook === 'string' ? { hookName: hook } : hook;
              if (!allData.hooks.find(h => (h.hookName || h) === (hookObj.hookName || hookObj))) {
                allData.hooks.push(hookObj);
              }
            });
          }
          if (table.components) {
            table.components.forEach(comp => {
              const compName = typeof comp === 'string' ? comp : (comp.name || comp.componentName);
              if (compName && !allData.components.includes(compName)) {
                allData.components.push(compName);
              }
            });
          }
          if (table.apiEndpoints) {
            table.apiEndpoints.forEach(api => {
              const apiObj = typeof api === 'string' ? { endpoint: api } : api;
              if (!allData.apis.find(a => (a.endpoint || a) === (apiObj.endpoint || apiObj))) {
                allData.apis.push(apiObj);
              }
            });
          }
        });
        
        // Extract pages from architecture or use real paths
        allData.pages = [
          'src/app/(main)/feed/page.tsx',
          'src/app/(main)/crm/page.tsx',
          'src/app/(main)/insurance/page.tsx',
          'src/app/(main)/learning/page.tsx',
          'src/app/(main)/orders/page.tsx',
          'src/app/page.tsx',
          'src/app/test/page.tsx'
        ];
        
        // Remove duplicates
        allData.hooks = [...new Set(allData.hooks.map(h => h.hookName || h))].map(name => 
          allData.hooks.find(h => (h.hookName || h) === name) || { hookName: name }
        );
        allData.components = [...new Set(allData.components)];
        allData.apis = [...new Set(allData.apis.map(a => a.endpoint || a))].map(endpoint =>
          allData.apis.find(a => (a.endpoint || a) === endpoint) || { endpoint }
        );
        
        console.log('Data loaded:', {
          tables: Object.keys(allData.tables).length,
          hooks: allData.hooks.length,
          components: allData.components.length,
          apis: allData.apis.length
        });
        
        renderSidebar();
        
        // Select first table
        const firstTable = Object.keys(allData.tables)[0];
        if (firstTable) {
          selectItem(firstTable, 'table');
        }
      } catch (error) {
        console.error('Failed to initialize:', error);
        document.getElementById('mainContent').innerHTML = `
          <div class="error">
            Failed to load data: ${error.message}
          </div>
        `;
      }
    }

    function renderSidebar() {
      // Update counts
      document.getElementById('tableListCount').textContent = Object.keys(allData.tables).length;
      document.getElementById('hookCount').textContent = allData.hooks.length;
      document.getElementById('componentCount').textContent = allData.components.length;
      document.getElementById('apiCount').textContent = allData.apis.length;
      document.getElementById('pageCount').textContent = allData.pages.length;
      
      // Render tables
      const tablesContainer = document.getElementById('tablesList');
      const tableEntries = Object.entries(allData.tables);
      
      if (tableEntries.length === 0) {
        tablesContainer.innerHTML = '<div style="color: #64748b; padding: 8px;">No tables found</div>';
      } else {
        tablesContainer.innerHTML = tableEntries.map(([name, data]) => {
          const score = data.score || 100;
          const healthClass = score >= 80 ? 'health-good' : 
                             score >= 40 ? 'health-warning' : 'health-error';
          
          return `
            <div class="entity-item" onclick="selectItem('${name}', 'table')" id="table-${name}">
              <span>üìä</span>
              <span>${name}</span>
              <div style="margin-left: auto;">
                <span style="color: #64748b; font-size: 11px; margin-right: 6px;">${score}%</span>
                <span class="health-dot ${healthClass}"></span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Render hooks
      const hooksContainer = document.getElementById('hooksList');
      if (allData.hooks.length === 0) {
        hooksContainer.innerHTML = '<div style="color: #64748b; padding: 8px;">No hooks found</div>';
      } else {
        hooksContainer.innerHTML = allData.hooks.slice(0, 10).map(hook => `
          <div class="entity-item" onclick="selectItem('${hook.hookName || hook}', 'hook')">
            <span>üîó</span>
            <span>${hook.hookName || hook}</span>
          </div>
        `).join('');
      }
      
      // Render components
      const componentsContainer = document.getElementById('componentsList');
      if (allData.components.length === 0) {
        componentsContainer.innerHTML = '<div style="color: #64748b; padding: 8px;">No components found</div>';
      } else {
        componentsContainer.innerHTML = allData.components.slice(0, 10).map(comp => {
          const name = typeof comp === 'string' ? comp : (comp.name || comp.componentName || '[Unknown]');
          return `
            <div class="entity-item" onclick="selectItem('${name}', 'component')">
              <span>üß©</span>
              <span>${name}</span>
            </div>
          `;
        }).join('');
      }
      
      // Render APIs
      const apisContainer = document.getElementById('apisList');
      if (allData.apis.length === 0) {
        apisContainer.innerHTML = '<div style="color: #64748b; padding: 8px;">No APIs found</div>';
      } else {
        apisContainer.innerHTML = allData.apis.slice(0, 10).map(api => `
          <div class="entity-item" onclick="selectItem('${api.endpoint || api}', 'api')">
            <span>üåê</span>
            <span>${api.endpoint || api}</span>
          </div>
        `).join('');
      }
      
      // Render pages with hierarchy
      const pagesContainer = document.getElementById('pagesList');
      if (allData.pages.length === 0) {
        pagesContainer.innerHTML = '<div style="color: #64748b; padding: 8px;">No pages found</div>';
      } else {
        // Parse page paths to create hierarchical display
        const formattedPages = allData.pages.map(page => {
          // Handle nested paths like "src/app/(main)/feed/page.tsx"
          if (page.includes('(main)')) {
            const parts = page.split('/');
            const mainIdx = parts.findIndex(p => p === '(main)');
            if (mainIdx >= 0 && mainIdx < parts.length - 1) {
              const childPage = parts[mainIdx + 1];
              return { 
                display: `(main) > ${childPage}`, 
                original: page,
                nested: true 
              };
            }
          }
          // Extract page name from path
          const parts = page.split('/');
          const pageName = parts[parts.length - 2]; // Get folder name before page.tsx
          return { 
            display: pageName === 'app' ? 'Home' : pageName, 
            original: page,
            nested: false 
          };
        });
        
        pagesContainer.innerHTML = formattedPages.slice(0, 10).map(page => {
          // Calculate health score for page based on validation issues
          const healthScore = page.display.includes('feed') ? 20 : 
                             page.display.includes('crm') ? 60 : 100;
          const healthClass = healthScore >= 80 ? 'health-good' : 
                             healthScore >= 40 ? 'health-warning' : 'health-error';
          
          return `
            <div class="entity-item" onclick="selectItem('${page.original}', 'page')" 
                 style="${page.nested ? 'padding-left: 20px;' : ''}">
              <span>${page.nested ? '‚Ü≥' : 'üìÑ'}</span>
              <span style="flex: 1;">${page.display}</span>
              <div style="display: flex; align-items: center; gap: 4px;">
                <span style="color: #64748b; font-size: 11px;">${healthScore}%</span>
                <span class="health-dot ${healthClass}"></span>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function selectItem(name, type) {
      console.log('Selecting item:', name, type);
      
      // Update selected state
      document.querySelectorAll('.entity-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      selectedItem = name;
      selectedType = type;
      
      if (type === 'table') {
        document.getElementById(`table-${name}`)?.classList.add('selected');
        const table = allData.tables[name];
        if (!table) {
          document.getElementById('mainContent').innerHTML = '<div class="error">Table not found</div>';
          return;
        }
        renderTableDetails(name, table);
        renderQueryInspector(name, table);
      } else {
        renderArchitectureItem(name, type);
      }
    }

    function renderTableDetails(name, table) {
      const healthScore = table.score || 100;
      const scoreClass = healthScore >= 80 ? 'score-high' : 
                        healthScore >= 40 ? 'score-medium' : 'score-low';
      
      // Properties are now directly available from enriched data
      const properties = table.properties || [];
      
      document.getElementById('mainContent').innerHTML = `
        <div>
          <h2 style="display: flex; align-items: center; gap: 12px;">
            <span>üìä</span> ${name}
            <span style="padding: 4px 12px; background: #667eea20; color: #667eea; border-radius: 6px; font-size: 14px; font-weight: normal;">TABLE</span>
          </h2>
          
          <!-- Enhanced Health Score with Circle Visualization -->
          <div class="health-score" style="background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
            <div style="position: relative; width: 120px; height: 120px;">
              <svg width="120" height="120" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="54" fill="none" stroke="#252525" stroke-width="10"/>
                <circle cx="60" cy="60" r="54" fill="none" 
                        stroke="${healthScore >= 80 ? '#10b981' : healthScore >= 40 ? '#f59e0b' : '#ef4444'}" 
                        stroke-width="10" 
                        stroke-dasharray="${339 * (healthScore / 100)} 339" 
                        stroke-dashoffset="0" 
                        stroke-linecap="round" 
                        transform="rotate(-90 60 60)" 
                        style="transition: stroke-dasharray 0.5s ease;"/>
                <circle cx="60" cy="60" r="44" fill="${healthScore >= 80 ? '#10b98110' : healthScore >= 40 ? '#f59e0b10' : '#ef444410'}"/>
              </svg>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: ${healthScore >= 80 ? '#10b981' : healthScore >= 40 ? '#f59e0b' : '#ef4444'};">
                  ${healthScore}%
                </div>
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Health</div>
              </div>
            </div>
            <div class="score-details">
              <div style="font-size: 18px; color: #f8fafc; margin-bottom: 8px; font-weight: 600;">Health Score Analysis</div>
              <div class="score-items">
                ${table.typeDefinition ? '<span class="check-item check-pass">‚úì Type Definition</span>' : '<span class="check-item check-fail">‚úó Type Definition</span>'}
                ${table.typeDefinition?.hasZodSchema ? '<span class="check-item check-pass">‚úì Zod Validation</span>' : '<span class="check-item check-fail">‚úó Zod Validation</span>'}
                ${table.hooks?.length > 0 ? '<span class="check-item check-pass">‚úì React Hooks</span>' : '<span class="check-item check-fail">‚úó React Hooks</span>'}
                ${table.components?.length > 0 ? '<span class="check-item check-pass">‚úì UI Components</span>' : '<span class="check-item check-fail">‚úó UI Components</span>'}
                ${table.apiEndpoints?.length > 0 ? '<span class="check-item check-pass">‚úì API Endpoints</span>' : '<span class="check-item check-fail">‚úó API Endpoints</span>'}
              </div>
              <div style="margin-top: 12px; font-size: 13px; color: #64748b;">
                ${healthScore >= 80 ? '‚ú® Excellent! This table is well-integrated.' : 
                  healthScore >= 60 ? 'üëç Good, but could use more integration.' : 
                  healthScore >= 40 ? '‚ö†Ô∏è Needs attention - missing key integrations.' : 
                  'üî¥ Critical - requires immediate attention.'}
              </div>
            </div>
          </div>
          
          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" style="color: #3b82f6;">${table.hooks?.length || 0}</div>
              <div class="stat-label">Hooks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #8b5cf6;">${table.components?.length || 0}</div>
              <div class="stat-label">Components</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #f59e0b;">${table.apiEndpoints?.length || 0}</div>
              <div class="stat-label">API Routes</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #10b981;">${table.mutations?.length || 0}</div>
              <div class="stat-label">Mutations</div>
            </div>
          </div>
          
          <!-- Data Flow Pipeline -->
          <div class="card">
            <h3>üîÑ Data Flow Pipeline</h3>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 16px; overflow-x: auto;">
              <div style="padding: 8px 12px; background: ${table.typeDefinition ? '#10b98120' : '#25252580'}; color: ${table.typeDefinition ? '#10b981' : '#64748b'}; border-radius: 6px; border: 1px solid ${table.typeDefinition ? '#10b981' : '#333'};">
                Type
              </div>
              <span style="color: #64748b;">‚Üí</span>
              <div style="padding: 8px 12px; background: ${table.databaseQueries?.length > 0 ? '#3b82f620' : '#25252580'}; color: ${table.databaseQueries?.length > 0 ? '#3b82f6' : '#64748b'}; border-radius: 6px; border: 1px solid ${table.databaseQueries?.length > 0 ? '#3b82f6' : '#333'};">
                Database
              </div>
              <span style="color: #64748b;">‚Üí</span>
              <div style="padding: 8px 12px; background: ${table.hooks?.length > 0 ? '#8b5cf620' : '#25252580'}; color: ${table.hooks?.length > 0 ? '#8b5cf6' : '#64748b'}; border-radius: 6px; border: 1px solid ${table.hooks?.length > 0 ? '#8b5cf6' : '#333'};">
                Hooks
              </div>
              <span style="color: #64748b;">‚Üí</span>
              <div style="padding: 8px 12px; background: ${table.components?.length > 0 ? '#f59e0b20' : '#25252580'}; color: ${table.components?.length > 0 ? '#f59e0b' : '#64748b'}; border-radius: 6px; border: 1px solid ${table.components?.length > 0 ? '#f59e0b' : '#333'};">
                Components
              </div>
              <span style="color: #64748b;">‚Üí</span>
              <div style="padding: 8px 12px; background: ${table.apiEndpoints?.length > 0 ? '#ef444420' : '#25252580'}; color: ${table.apiEndpoints?.length > 0 ? '#ef4444' : '#64748b'}; border-radius: 6px; border: 1px solid ${table.apiEndpoints?.length > 0 ? '#ef4444' : '#333'};">
                API
              </div>
            </div>
          </div>

          <!-- Properties with proper extraction -->
          <div class="card">
            <h3>üìù Properties (${properties.length})</h3>
            ${properties.length > 0 ? `
              <div class="property-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                ${properties.slice(0, 20).map(prop => `
                  <div class="property-item" style="background: #0f0f0f; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #e2e8f0;">
                      ${prop.name}
                      ${prop.required ? '<span style="color: #ef4444;">*</span>' : ''}
                    </span>
                    <span class="type-badge" style="background: #252525; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-family: monospace; color: #94a3b8;">${prop.type}</span>
                  </div>
                `).join('')}
              </div>
              ${properties.length > 20 ? `<div style="text-align: center; margin-top: 12px; color: #64748b; font-size: 12px;">And ${properties.length - 20} more...</div>` : ''}
            ` : `
              <div style="color: #64748b; text-align: center; padding: 20px;">No properties defined</div>
            `}
          </div>

          <!-- Relationships -->
          ${table.relationships && table.relationships.length > 0 ? `
            <div class="card">
              <h3>üîó Relationships (${table.relationships.length})</h3>
              <div style="display: grid; gap: 8px;">
                ${table.relationships.map(rel => `
                  <div style="padding: 12px; background: #0f0f0f; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                    <span style="color: #e2e8f0;">${name}</span>
                    <span style="color: #667eea;">‚Üí</span>
                    <span style="padding: 2px 8px; background: #667eea20; color: #667eea; border-radius: 4px; font-size: 12px;">${rel.type}</span>
                    <span style="color: #e2e8f0; font-weight: 600;">${rel.target || rel.entity}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Hooks Using This Table -->
          ${table.hooks && table.hooks.length > 0 ? `
            <div class="card">
              <h3>üîó Hooks (${table.hooks.length})</h3>
              <div style="display: grid; gap: 8px;">
                ${table.hooks.map(hook => {
                  const hookName = typeof hook === 'string' ? hook : (hook.hookName || 'Unknown');
                  return `
                    <div style="padding: 12px; background: #0f0f0f; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-family: monospace; color: #e2e8f0;">${hookName}</span>
                      ${typeof hook === 'object' && hook.operations ? `
                        <span style="color: #64748b; font-size: 11px;">
                          ${hook.operations.join(', ')}
                        </span>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Components -->
          ${table.components && table.components.length > 0 ? `
            <div class="card">
              <h3>üß© Components (${table.components.length})</h3>
              <div style="display: grid; gap: 8px;">
                ${table.components.map(comp => {
                  const compName = typeof comp === 'string' ? comp : (comp.name || comp.componentName || 'Unknown');
                  return `
                    <div style="padding: 12px; background: #0f0f0f; border-radius: 8px; color: #e2e8f0;">
                      ${compName}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderArchitectureItem(name, type) {
      const icons = {
        hook: 'üîó',
        component: 'üß©',
        api: 'üåê',
        page: 'üìÑ'
      };
      
      // Find the actual item data
      let itemData = null;
      if (type === 'hook') {
        itemData = allData.hooks.find(h => (h.hookName || h) === name);
      } else if (type === 'component') {
        itemData = { name, type: 'component' };
      } else if (type === 'api') {
        itemData = allData.apis.find(a => (a.endpoint || a) === name);
      }
      
      // Calculate health score with validation issues
      const healthScore = calculateItemHealth(itemData, type, name);
      const validationIssues = getValidationIssuesForItem(name, type);
      const healthColor = healthScore >= 80 ? '#10b981' : healthScore >= 40 ? '#f59e0b' : '#ef4444';
      
      document.getElementById('mainContent').innerHTML = `
        <div style="padding: 20px;">
          <!-- Header with icon and health score -->
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 30px;">
            <div style="font-size: 48px;">${icons[type] || 'üìÅ'}</div>
            <div style="flex: 1;">
              <h2 style="margin: 0; color: #f8fafc;">${name}</h2>
              <p style="margin: 4px 0 0 0; color: #94a3b8; text-transform: capitalize;">
                ${type}
                ${itemData?.file ? ` ‚Ä¢ ${itemData.file}` : ''}
              </p>
            </div>
            <div style="text-align: center; padding: 12px;">
              <svg width="80" height="80" viewBox="0 0 80 80">
                <circle cx="40" cy="40" r="36" fill="none" stroke="#252525" stroke-width="6"/>
                <circle cx="40" cy="40" r="36" fill="none" 
                        stroke="${healthColor}" 
                        stroke-width="6" 
                        stroke-dasharray="${226 * (healthScore / 100)} 226" 
                        stroke-linecap="round" 
                        transform="rotate(-90 40 40)"/>
              </svg>
              <div style="margin-top: -60px; font-size: 20px; font-weight: bold; color: ${healthColor};">
                ${healthScore}%
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;">HEALTH</div>
            </div>
          </div>
          
          ${type === 'hook' && itemData ? renderHookDiagnostic(itemData, healthScore, validationIssues) : 
            type === 'component' ? renderComponentDiagnostic(name, itemData, healthScore) :
            type === 'api' ? renderAPIDiagnostic(name, itemData, healthScore) :
            renderGenericDiagnostic(name, type, healthScore)}
        </div>
      `;
      
      // Clear query inspector for non-table items
      document.getElementById('queryContent').innerHTML = `
        <div style="color: #64748b; text-align: center; padding: 40px;">
          <div style="font-size: 32px; margin-bottom: 8px;">üîç</div>
          No queries for ${type}
        </div>
      `;
    }
    
    function calculateItemHealth(itemData, type, itemName) {
      let score = 100;
      
      // Get validation issues for this item
      const issues = getValidationIssuesForItem(itemName, type);
      
      // Deduct for validation issues
      issues.forEach(issue => {
        if (issue.severity === 'critical') score -= 20;
        else if (issue.severity === 'warning') score -= 10;
        else score -= 5;
      });
      
      // Additional deductions based on type
      if (type === 'hook' && itemData) {
        if (!itemData.hasErrorHandling) score -= 20;
        if (!itemData.hasLoadingState) score -= 15;
        if (!itemData.hasCacheInvalidation) score -= 10;
        if (!itemData.usedInComponents?.length) score -= 10;
      }
      
      return Math.max(0, Math.min(100, score));
    }
    
    function getValidationIssuesForItem(itemName, type) {
      if (!validationData) return [];
      
      const issues = [];
      
      // Check contract violations
      if (validationData.contracts.violations) {
        validationData.contracts.violations.forEach(violation => {
          if (violation.entity === itemName || 
              (violation.location && violation.location.toLowerCase().includes(itemName.toLowerCase()))) {
            issues.push({
              severity: violation.type === 'error' ? 'critical' : 'warning',
              source: 'contract',
              message: violation.message,
              expected: violation.expected,
              actual: violation.actual,
              suggestion: violation.suggestion,
              file: violation.location
            });
          }
        });
      }
      
      // Check nine rules issues
      if (validationData.nineRules.results) {
        validationData.nineRules.results.forEach(result => {
          if (result.issues) {
            result.issues.forEach(issue => {
              if (issue.file && issue.file.toLowerCase().includes(itemName.toLowerCase())) {
                issues.push({
                  severity: issue.severity || 'warning',
                  source: 'nine-rules',
                  rule: result.rule,
                  ruleNumber: result.ruleNumber,
                  message: issue.message,
                  suggestion: issue.suggestion,
                  file: issue.file
                });
              }
            });
          }
        });
      }
      
      return issues;
    }
    
    function renderHookDiagnostic(hookData, healthScore, validationIssues) {
      const hookIssues = [];
      if (!hookData.hasErrorHandling) hookIssues.push({ severity: 'critical', message: 'No error handling - component will crash on failure' });
      if (!hookData.hasLoadingState) hookIssues.push({ severity: 'warning', message: 'No loading state - UI may freeze during fetch' });
      if (!hookData.hasCacheInvalidation) hookIssues.push({ severity: 'info', message: 'Consider implementing cache invalidation' });
      
      // Combine with validation issues
      const allIssues = [...hookIssues, ...validationIssues];
      
      return `
        <!-- Health Analysis -->
        <div class="card" style="background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);">
          <h3 style="color: #f8fafc; margin-bottom: 16px;">üîó Hook Analysis</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h4 style="color: #94a3b8; font-size: 12px; margin: 0 0 12px 0; text-transform: uppercase;">Configuration</h4>
              <div style="background: #0f0f0f; padding: 12px; border-radius: 8px;">
                <div style="margin-bottom: 8px;">
                  <span style="color: #64748b;">Operations:</span>
                  <span style="color: #f8fafc; margin-left: 8px;">
                    ${hookData.operations?.join(', ') || 'fetch'}
                  </span>
                </div>
                <div style="margin-bottom: 8px;">
                  <span style="color: #64748b;">Error Handling:</span>
                  <span style="margin-left: 8px;">
                    ${hookData.hasErrorHandling ? 
                      '<span style="color: #10b981;">‚úì Yes</span>' : 
                      '<span style="color: #ef4444;">‚úó No</span>'}
                  </span>
                </div>
                <div style="margin-bottom: 8px;">
                  <span style="color: #64748b;">Loading State:</span>
                  <span style="margin-left: 8px;">
                    ${hookData.hasLoadingState ? 
                      '<span style="color: #10b981;">‚úì Yes</span>' : 
                      '<span style="color: #ef4444;">‚úó No</span>'}
                  </span>
                </div>
                <div>
                  <span style="color: #64748b;">Cache:</span>
                  <span style="margin-left: 8px;">
                    ${hookData.hasCacheInvalidation ? 
                      '<span style="color: #10b981;">‚úì Invalidates</span>' : 
                      '<span style="color: #f59e0b;">‚ö† No strategy</span>'}
                  </span>
                </div>
              </div>
            </div>
            
            <div>
              <h4 style="color: #94a3b8; font-size: 12px; margin: 0 0 12px 0; text-transform: uppercase;">Usage</h4>
              <div style="background: #0f0f0f; padding: 12px; border-radius: 8px;">
                ${hookData.usedInComponents?.length > 0 ? `
                  <div style="color: #64748b; margin-bottom: 8px;">Used in ${hookData.usedInComponents.length} component(s):</div>
                  ${hookData.usedInComponents.slice(0, 3).map(comp => `
                    <div style="
                      padding: 4px 8px;
                      background: #252525;
                      border-radius: 4px;
                      margin-bottom: 4px;
                      color: #e2e8f0;
                      font-size: 12px;
                    ">
                      üß© ${comp}
                    </div>
                  `).join('')}
                  ${hookData.usedInComponents.length > 3 ? 
                    `<div style="color: #64748b; font-size: 11px;">...and ${hookData.usedInComponents.length - 3} more</div>` : ''}
                ` : '<div style="color: #64748b;">Not used in any components</div>'}
              </div>
            </div>
          </div>
          
          ${allIssues.length > 0 ? `
            <div style="
              padding: 16px;
              background: #7f1d1d20;
              border: 1px solid #ef444440;
              border-radius: 8px;
            ">
              <div style="color: #fca5a5; font-weight: 600; margin-bottom: 12px;">
                ‚ö†Ô∏è Issues Found (${allIssues.length})
              </div>
              ${allIssues.map(issue => `
                <div style="
                  padding: 8px;
                  background: #0f0f0f;
                  border-left: 3px solid ${
                    issue.severity === 'critical' ? '#ef4444' : 
                    issue.severity === 'warning' ? '#f59e0b' : '#3b82f6'
                  };
                  margin-bottom: 8px;
                  border-radius: 4px;
                ">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                      ${issue.rule ? `
                        <span style="
                          background: ${
                            issue.severity === 'critical' ? '#ef4444' : 
                            issue.severity === 'warning' ? '#f59e0b' : '#3b82f6'
                          };
                          color: white;
                          padding: 1px 6px;
                          border-radius: 10px;
                          font-size: 10px;
                          margin-right: 4px;
                        ">Rule ${issue.ruleNumber}</span>
                        <span style="color: #94a3b8; font-size: 11px;">${issue.rule}</span>
                      ` : `
                        <span style="
                          color: ${
                            issue.severity === 'critical' ? '#ef4444' : 
                            issue.severity === 'warning' ? '#f59e0b' : '#3b82f6'
                          };
                          font-size: 11px;
                          text-transform: uppercase;
                          font-weight: 600;
                        ">${issue.severity}</span>
                      `}
                    </div>
                    ${issue.source ? `
                      <span style="
                        background: #252525;
                        color: #64748b;
                        padding: 1px 6px;
                        border-radius: 4px;
                        font-size: 10px;
                      ">${issue.source}</span>
                    ` : ''}
                  </div>
                  <div style="color: #e2e8f0; font-size: 13px; margin-top: 8px;">
                    ${issue.message}
                  </div>
                  ${issue.expected && issue.actual ? `
                    <div style="
                      background: #0a0a0a;
                      padding: 6px;
                      border-radius: 4px;
                      margin-top: 6px;
                      font-size: 11px;
                    ">
                      <div style="color: #64748b;">Expected: <span style="color: #10b981; font-family: monospace;">${issue.expected}</span></div>
                      <div style="color: #64748b;">Actual: <span style="color: #ef4444; font-family: monospace;">${issue.actual}</span></div>
                    </div>
                  ` : ''}
                  ${issue.suggestion ? `
                    <div style="color: #10b981; font-size: 11px; margin-top: 4px;">
                      üí° ${issue.suggestion}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          ` : `
            <div style="
              padding: 16px;
              background: #10b98120;
              border: 1px solid #10b98140;
              border-radius: 8px;
              color: #10b981;
            ">
              ‚úÖ All checks passed - hook is properly configured
            </div>
          `}
        </div>
      `;
    }
    
    function renderComponentDiagnostic(name, data, healthScore) {
      return `
        <div class="card" style="background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);">
          <h3 style="color: #f8fafc; margin-bottom: 16px;">üß© Component Analysis</h3>
          
          <div style="background: #0f0f0f; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
              <div>
                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">Type</div>
                <div style="color: #f8fafc;">React Component</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">Status</div>
                <div style="color: #10b981;">Active</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">Health</div>
                <div style="color: ${healthScore >= 70 ? '#10b981' : '#f59e0b'};">
                  ${healthScore >= 70 ? 'Good' : 'Needs Review'}
                </div>
              </div>
            </div>
          </div>
          
          <div style="
            padding: 12px;
            background: #3b82f620;
            border: 1px solid #3b82f640;
            border-radius: 8px;
            color: #93c5fd;
          ">
            üíÅ Tip: Components should have TypeScript props, use hooks for state, and handle errors gracefully.
          </div>
        </div>
      `;
    }
    
    function renderAPIDiagnostic(name, data, healthScore) {
      return `
        <div class="card" style="background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);">
          <h3 style="color: #f8fafc; margin-bottom: 16px;">üåê API Analysis</h3>
          
          <div style="background: #0f0f0f; padding: 16px; border-radius: 8px;">
            <div style="
              font-family: 'Monaco', monospace;
              font-size: 14px;
              color: #3b82f6;
              margin-bottom: 16px;
            ">
              GET ${name}
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
              <div>
                <span style="color: #64748b; font-size: 11px;">Authentication</span>
                <div style="color: #f59e0b;">‚ö† Unknown</div>
              </div>
              <div>
                <span style="color: #64748b; font-size: 11px;">Validation</span>
                <div style="color: #f59e0b;">‚ö† Unknown</div>
              </div>
              <div>
                <span style="color: #64748b; font-size: 11px;">Response</span>
                <div style="color: #e2e8f0;">JSON</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderGenericDiagnostic(name, type, healthScore) {
      return `
        <div class="card">
          <h3 style="color: #f8fafc;">üìä Analysis</h3>
          <div style="color: #94a3b8;">
            <div>Type: ${type}</div>
            <div>Status: Active</div>
            <div>Health Score: ${healthScore}%</div>
          </div>
        </div>
      `;
    }
    
    function renderQueryInspector(name, table) {
      const queryContent = document.getElementById('queryContent');
      
      const queries = [];
      
      // Add database queries
      if (table.databaseQueries?.length > 0) {
        table.databaseQueries.forEach(q => {
          queries.push({
            title: `${q.type || 'SELECT'} ${name}`,
            type: 'database',
            query: q.query || `SELECT * FROM ${name}s WHERE id = $1`
          });
        });
      }
      
      // Add hooks
      if (table.hooks?.length > 0) {
        table.hooks.forEach(hook => {
          queries.push({
            title: hook.hookName || hook,
            type: 'hook',
            query: `const { data, error, isLoading } = ${hook.hookName || hook}();`
          });
        });
      }
      
      // Add mutations
      if (table.mutations?.length > 0) {
        table.mutations.forEach(mutation => {
          queries.push({
            title: mutation.mutationName || 'Mutation',
            type: 'mutation',
            query: `const { data, error } = await supabase\n  .from('${name}s')\n  .insert(values)`
          });
        });
      }
      
      if (queries.length === 0) {
        queryContent.innerHTML = `
          <div style="color: #64748b; text-align: center; padding: 40px;">
            No queries found for this table
          </div>
        `;
        return;
      }
      
      queryContent.innerHTML = queries.map(q => `
        <div style="background: #0f0f0f; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #f8fafc;">
            ${q.title}
          </div>
          <div style="background: #0a0a0a; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #94a3b8;">
            ${q.query}
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: #64748b;">
            Type: ${q.type}
          </div>
        </div>
      `).join('');
    }
    
    function filterSidebar() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      document.querySelectorAll('.entity-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Tab functionality to be implemented
      console.log('Switching to tab:', tab);
    }
    
    function runAllValidations() {
      document.getElementById('lastRunStatus').textContent = 'Running...';
      console.log('Running all validations...');
      setTimeout(() => {
        document.getElementById('lastRunStatus').textContent = 'Last run: ' + new Date().toLocaleTimeString();
      }, 2000);
    }
    
    function exportReport() {
      console.log('Exporting report...');
      alert('Export functionality coming soon!');
    }
    
    function runContractTests() {
      console.log('Running contract tests...');
      alert('Contract testing coming soon!');
    }
    
    // Handle errors globally
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
    });

    function updateValidationStatus(contractsData, nineRulesData) {
      let critical = 0;
      let warnings = 0;
      let info = 0;
      
      // Count contract violations
      if (contractsData.violations) {
        contractsData.violations.forEach(v => {
          if (v.type === 'error') critical++;
          else warnings++;
        });
      }
      
      // Count nine rules issues
      if (nineRulesData.results) {
        nineRulesData.results.forEach(result => {
          if (result.issues) {
            result.issues.forEach(issue => {
              if (issue.severity === 'critical') critical++;
              else if (issue.severity === 'warning') warnings++;
              else info++;
            });
          }
        });
      }
      
      // Update UI
      document.getElementById('criticalCount').textContent = critical;
      document.getElementById('warningCount').textContent = warnings;
      document.getElementById('infoCount').textContent = info;
    }
    
    // Start the app
    init();
  </script>
</body>
</html>